<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Assess Offline v4.1</title>
<style>
    /* --- PREMIUM THEME (Google Blue / OLED Black) --- */
    :root {
        --primary: #1a73e8; --on-primary: #ffffff;
        --bg: #f8f9fa; --surface: #ffffff;
        --text: #202124; --text-sec: #5f6368;
        --border: #dadce0;
        --success: #1e8e3e; --success-bg: #e6f4ea;
        --warn: #e37400; --warn-bg: #fef7e0;
        --error: #d93025; --error-bg: #fce8e6;
        --shadow: 0 4px 6px rgba(60, 64, 67, 0.1);
        --strip: #e8eaed; --strip-text: #5f6368;
        --zebra: #f1f3f4;
        --input-bg: #f1f3f4;
    }
    body.dark {
        --primary: #8ab4f8; --on-primary: #000000;
        --bg: #000000; --surface: #121212;
        --text: #e8eaed; --text-sec: #9aa0a6;
        --border: #3c4043;
        --success: #81c995; --success-bg: #0c1e12;
        --warn: #fdd663; --warn-bg: #292008;
        --error: #f28b82; --error-bg: #370b09;
        --shadow: 0 4px 12px rgba(0,0,0,0.5);
        --strip: #202124; --strip-text: #9aa0a6;
        --zebra: #1a1a1a;
        --input-bg: #202124;
    }
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; margin: 0; background: var(--bg); color: var(--text); padding-top: 100px; padding-bottom: 90px; transition: background 0.2s, color 0.2s; }
    button { cursor: pointer; user-select: none; font-family: inherit; transition: transform 0.1s; }
    button:active { transform: scale(0.96); }

    /* --- HEADER --- */
    header {
        position: fixed; top: 0; left: 0; width: 100%; height: 60px;
        background: var(--surface); color: var(--text);
        display: flex; align-items: center; padding: 0 16px;
        z-index: 1000; box-shadow: 0 1px 2px rgba(0,0,0,0.08);
        border-bottom: 1px solid var(--border);
    }
    .brand-strip {
        position: fixed; top: 60px; left: 0; width: 100%; height: 28px;
        background: var(--strip); color: var(--strip-text);
        font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px;
        display: flex; align-items: center; justify-content: center;
        z-index: 990;
    }
    .menu-icon { background: none; border: none; font-size: 24px; color: var(--text); padding: 8px; margin-right: 12px; border-radius: 50%; }
    .header-titles { flex: 1; overflow: hidden; display:flex; flex-direction:column; justify-content:center; }
    .header-titles h1 { margin: 0; font-size: 16px; font-weight: 600; color: var(--primary); white-space: normal; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; line-height: 1.1; }
    .header-titles p { margin: 0; font-size: 11px; color: var(--text-sec); margin-top:2px; }
    .footer-icon { position: absolute; right: 10px; top: 0; height: 100%; background: none; border: none; font-size: 16px; color: var(--strip-text); display: flex; align-items: center; padding: 0 12px; transform: scaleX(-1); }
    .footer-icon.active { color: var(--warn); }
    .btn-pdf { background: var(--primary); color: var(--on-primary); border: none; padding: 6px 14px; border-radius: 50px; font-size: 13px; font-weight: 600; display: flex; align-items: center; gap: 6px; box-shadow: 0 1px 3px rgba(0,0,0,0.2); }

    /* --- LAYOUT --- */
    .container { max-width: 800px; margin: 0 auto; padding: 10px 16px; min-height: 60vh; }
    .empty-state { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 50vh; text-align: center; color: var(--text-sec); animation: fadeIn 0.5s; }
    .card { background: var(--surface); border-radius: 12px; padding: 16px; margin-bottom: 12px; box-shadow: var(--shadow); border: 1px solid var(--border); border-left: 5px solid transparent; position: relative; display: flex; align-items: center; gap: 12px; }
    .card.pass { border-left-color: var(--success); }
    .card.fail { border-left-color: var(--error); }
    .sel-chk { width: 24px; height: 24px; border: 2px solid var(--text-sec); border-radius: 6px; display: none; align-items: center; justify-content: center; font-size: 16px; color: white; }
    .sel-chk.checked { background: var(--primary); border-color: var(--primary); }
    .sel-mode .sel-chk { display: flex; }
    .card-content { flex: 1; }
    .row-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
    .st-name { font-size: 16px; font-weight: 600; color: var(--text); }
    .st-score { font-size: 18px; font-weight: 800; color: var(--primary); }
    .tags { display: flex; gap: 8px; font-size: 10px; font-weight: 700; }
    .tag { padding: 3px 8px; border-radius: 4px; }
    .tag.inc { background: var(--warn-bg); color: var(--warn); }
    .tag.com { background: var(--success-bg); color: var(--success); }

    /* --- FAB --- */
    .fab { position: fixed; bottom: 24px; right: 24px; height: 56px; background: var(--primary); color: var(--on-primary); border-radius: 28px; border: none; box-shadow: 0 4px 12px rgba(0,0,0,0.3); font-size: 16px; font-weight: 600; display: flex; align-items: center; gap: 10px; padding: 0 24px; z-index: 900; }
    .sel-bar { position: fixed; bottom: 0; left: 0; width: 100%; height: 70px; background: var(--surface); border-top: 1px solid var(--border); display: none; align-items: center; justify-content: space-between; padding: 0 20px; z-index: 950; box-shadow: 0 -2px 10px rgba(0,0,0,0.05); }
    .sel-mode .fab { display: none; }
    .sel-mode .sel-bar { display: flex; }

    /* --- DRAWER --- */
    .overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 1100; backdrop-filter: blur(2px); }
    .drawer { position: fixed; top: 0; left: 0; width: 280px; height: 100%; background: var(--surface); z-index: 1200; transform: translateX(-100%); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); display: flex; flex-direction: column; border-right: 1px solid var(--border); }
    .drawer.open { transform: translateX(0); }
    .drawer-head { padding: 20px; background: var(--surface); border-bottom: 1px solid var(--border); }
    .drawer-body { flex: 1; overflow-y: auto; padding: 8px 0; }
    .sec-title { padding: 24px 20px 8px; font-size: 11px; font-weight: 700; color: var(--primary); text-transform: uppercase; letter-spacing: 1px; }
    .menu-item { padding: 14px 20px; font-size: 15px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; color: var(--text); border-left: 4px solid transparent; transition: background 0.1s; }
    .menu-item:active { background: var(--strip); }
    .menu-item.active-cls { background: rgba(26, 115, 232, 0.1); color: var(--primary); font-weight: 600; border-left-color: var(--primary); }
    .count-badge { font-size: 12px; font-weight: 600; color: var(--text-sec); padding: 2px 8px; border-radius: 10px; background: var(--strip); }
    .count-badge.done { color: var(--success); background: var(--success-bg); }

    /* --- MODALS --- */
    .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg); z-index: 1500; overflow-y: auto; }
    .modal-head { position: sticky; top: 0; background: var(--surface); border-bottom: 1px solid var(--border); padding: 12px 16px; display: flex; justify-content: space-between; align-items: center; z-index: 1510; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
    .modal-body { padding: 20px; max-width: 600px; margin: 0 auto; padding-bottom: 120px; }
    .inp-grp { margin-bottom: 16px; }
    .inp-grp label { display: block; margin-bottom: 6px; font-size: 12px; font-weight: 600; color: var(--text-sec); text-transform: uppercase; letter-spacing: 0.5px; }
    .inp-txt, select.inp-txt { width: 100%; padding: 12px 14px; border: none; border-bottom: 2px solid var(--border); border-radius: 4px 4px 0 0; font-size: 16px; background: var(--input-bg); color: var(--text); font-family: inherit; -webkit-appearance: none; transition: border-color 0.2s, background 0.2s; }
    .inp-txt:focus { border-color: var(--primary); background: rgba(26, 115, 232, 0.05); }

    /* --- COMPACT GRID (OPTIMIZED) --- */
    .sub-card { background: var(--surface); border: 1px solid var(--border); border-radius: 0; padding: 10px; margin-bottom: 0; border-bottom: none; }
    .sub-card:first-of-type { border-top-left-radius: 12px; border-top-right-radius: 12px; }
    .sub-card:last-of-type { border-bottom-left-radius: 12px; border-bottom-right-radius: 12px; border-bottom: 1px solid var(--border); }
    .sub-card:nth-child(even) { background: var(--zebra); }
    .sub-head { font-weight: 700; color: var(--text); margin-bottom: 6px; font-size: 15px; }
    
    /* 75px forces 3 items per row on mobile */
    .mark-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(75px, 1fr)); gap: 6px; margin-bottom: 4px; }
    .mark-cell { text-align: center; }
    .mark-cell label { display: block; font-size: 9px; font-weight: 700; color: var(--text-sec); margin-bottom: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .mark-inp { width: 100%; padding: 8px 0; text-align: center; border: 1px solid var(--border); border-radius: 6px; font-size: 16px; font-weight: 700; background: var(--bg); color: var(--text); inputmode: decimal; }
    .mark-inp:focus { border-color: var(--primary); border-width: 2px; padding: 7px 0; }
    
    .btn-row { display: flex; gap: 10px; margin-top: 15px; }
    .btn-save { flex: 1; padding: 14px; background: var(--primary); color: var(--on-primary); border: none; font-size: 14px; font-weight: 600; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
    .btn-next { flex: 1; background: var(--surface); color: var(--primary); border: 2px solid var(--primary); box-shadow:none; }
    .btn-del { width: 100%; padding: 12px; background: var(--error-bg); color: var(--error); border: none; border-radius: 8px; font-weight: 700; font-size: 13px; margin-top: 20px; }
    
    .set-box { background: var(--surface); border: 1px solid var(--border); border-radius: 8px; padding: 16px; margin-bottom: 16px; }
    .set-title { font-weight: 700; color: var(--primary); margin-bottom: 12px; font-size: 13px; text-transform: uppercase; }
    .dual-sub-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 8px; }
    .sub-match-ui { font-size: 11px; font-weight: 600; text-align: right; margin-bottom: 12px; }
    .sub-match-ui.ok { color: var(--success); }
    .sub-match-ui.bad { color: var(--error); }

    .cfm-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1600; align-items: center; justify-content: center; backdrop-filter: blur(2px); }
    .cfm-box { background: var(--surface); padding: 25px; border-radius: 16px; width: 85%; max-width: 320px; text-align: center; }
    .toast { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%) translateY(50px); background: #323232; color: #fff; padding: 12px 24px; border-radius: 50px; font-size: 14px; opacity: 0; transition: 0.3s; pointer-events: none; z-index: 3000; white-space: nowrap; }
    .toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }
    
    #print-wrap { display: none; }
    @media print {
        body * { visibility: hidden; }
        #print-wrap, #print-wrap * { visibility: visible; }
        #print-wrap { display: block; position: absolute; left: 0; top: 0; width: 100%; }
        @page { size: A4 landscape; margin: 5mm; }
        table { width: 100%; border-collapse: collapse; font-family: 'Times New Roman', serif; font-size: 8pt; color: black; }
        th, td { border: 0.5pt solid black; padding: 2px; text-align: center; vertical-align: middle; }
        thead th { background: #eee !important; font-weight: bold; -webkit-print-color-adjust: exact; }
        .v-th { height: 120px; vertical-align: bottom; }
        .v-txt { writing-mode: vertical-rl; transform: rotate(180deg); margin: 0 auto; white-space: nowrap; font-size: 6.5pt; line-height: 1.1; }
        .t-left { text-align: left; padding-left: 4px; }
        .p-head { text-align: center; border-bottom: 1px solid black; margin-bottom: 8px; padding-bottom: 5px; }
        .page-break { page-break-before: always; }
        .gt-cell { font-weight: bold; font-size: 10pt; background: #f5f5f5; }
    }
</style>
</head>
<body>

<header>
    <button class="menu-icon" onclick="toggleDrawer()">‚ò∞</button>
    <div class="header-titles"><h1 id="ui-school">My Govt School</h1><p id="ui-class">Mark Register</p></div>
    <button class="btn-pdf" onclick="prepExport('single')">üìÑ PDF</button>
</header>
<div class="brand-strip">Developed by Sahil Kumar Rout<button class="footer-icon" id="sel-toggle" onclick="toggleSelMode()">‚úé</button></div>

<div class="container"><div id="list"></div></div>

<button class="fab" id="main-fab" onclick="editStudent(null)"><span style="font-size:24px; margin-right:4px;">+</span> Add Student</button>
<div class="sel-bar"><div style="font-weight:600" id="sel-count">0 Selected</div><button class="btn-del" onclick="deleteSelected()" style="margin:0; width:auto; padding:8px 16px;">DELETE SELECTED</button></div>

<div class="overlay" id="overlay" onclick="toggleDrawer()"></div>
<div class="drawer" id="drawer">
    <div class="drawer-head"><div style="font-weight:700; font-size:18px; color:var(--primary)">Assess Offline</div><div style="font-size:11px; opacity:0.7;">v4.1 (Final Stable)</div></div>
    <div class="drawer-body">
        <div class="sec-title">School Profile</div>
        <div style="padding:0 16px;">
            <div class="inp-grp"><label>School Name</label><input type="text" id="menu-school" class="inp-txt" oninput="updCF('school', this.value)"></div>
            <div class="inp-grp"><label>UDISE</label><input type="text" id="menu-udise" class="inp-txt" oninput="updCF('udise', this.value)"></div>
            <div class="inp-grp"><label>Session</label><input type="text" id="menu-ses" class="inp-txt" oninput="updCF('session', this.value)"></div>
        </div>
        <div class="sec-title">Class Registers</div><div id="menu-cls-list"></div>
        <div class="sec-title">Tools</div>
        <div onclick="prepExport('all')" class="menu-item">üñ®Ô∏è Print All Classes</div>
        <div onclick="genExcel()" class="menu-item">üìä Excel Export (.xls)</div>
        <div onclick="backupData()" class="menu-item">üíæ Backup Data</div>
        <div onclick="document.getElementById('file-res').click()" class="menu-item">üìÇ Restore Data</div><input type="file" id="file-res" style="display:none" onchange="restoreData(this)" accept="*/*">
        <div class="sec-title">Settings & About</div>
        <div onclick="toggleDark()" class="menu-item" id="theme-btn">Current Theme: Light</div>
        <div onclick="openSettings()" class="menu-item">‚öôÔ∏è Settings</div>
        <div onclick="openAbout()" class="menu-item">‚ÑπÔ∏è About & Support</div>
        <div onclick="resetAll()" class="menu-item" style="color:var(--error);">‚ö†Ô∏è Factory Reset</div>
    </div>
</div>

<div class="modal" id="mod-edit">
    <div class="modal-head"><span id="edit-title" style="font-weight:700">Student</span><button class="menu-icon" onclick="checkUnsaved()" style="margin:0">‚úï</button></div>
    <div class="modal-body">
        <div class="inp-grp" style="position:sticky; top:55px; z-index:10; background:var(--bg); padding:10px 0; border-bottom:1px solid var(--border)">
            <label>Student Name (Auto Capital)</label><input type="text" id="inp-name" class="inp-txt" style="text-transform:uppercase" placeholder="ENTER NAME">
        </div>
        <div id="marks-area"></div>
        <div class="btn-row"><button class="btn-save" onclick="preSaveCheck(false)">SAVE & CLOSE</button><button class="btn-save btn-next" onclick="preSaveCheck(true)">SAVE & NEXT ‚û°Ô∏è</button></div>
        <button class="btn-del" id="btn-del" onclick="delStudent()" style="display:none;">DELETE STUDENT</button>
    </div>
</div>

<div class="modal" id="mod-set">
    <div class="modal-head"><span style="font-weight:700">Settings</span><button class="menu-icon" onclick="closeModal('mod-set')" style="margin:0">‚úï</button></div>
    <div class="modal-body">
        <div class="inp-grp"><label>Report Language / ‡¨∞‡¨ø‡¨™‡≠ã‡¨∞‡≠ç‡¨ü ‡¨≠‡¨æ‡¨∑‡¨æ</label><select id="cfg-lang" class="inp-txt"><option value="od">Odia (‡¨ì‡¨°‡¨º‡¨ø‡¨Ü) [Default]</option><option value="en">English</option></select></div>
        <div class="set-box">
            <div class="set-title">Group A: Exam Limits (Max Marks)</div>
            <div style="display:flex; gap:10px;"><div class="inp-grp" style="flex:1"><label>FA Max</label><input type="number" id="lm-fa" class="inp-txt"></div><div class="inp-grp" style="flex:1"><label>SA Max</label><input type="number" id="lm-sa" class="inp-txt"></div></div>
            <div style="display:flex; gap:10px;"><div class="inp-grp" style="flex:1"><label>Written</label><input type="number" id="lm-wr" class="inp-txt"></div><div class="inp-grp" style="flex:1"><label>Project</label><input type="number" id="lm-pr" class="inp-txt"></div></div>
        </div>
        <div class="set-box">
            <div class="set-title">Group B: Weightage %</div>
            <div style="font-size:11px; font-weight:700; color:var(--text-sec); margin-bottom:5px;">Primary (Class 1-5)</div>
            <div style="display:flex; gap:5px;"><input type="number" id="pr-t1" class="inp-txt" placeholder="T1%"><input type="number" id="pr-wr" class="inp-txt" placeholder="Wr%"><input type="number" id="pr-pr" class="inp-txt" placeholder="Pr%"><input type="number" id="pr-sa" class="inp-txt" placeholder="An%"></div>
            <div style="font-size:11px; font-weight:700; color:var(--text-sec); margin:10px 0 5px;">Upper Primary (Class 6-8)</div>
            <div style="display:flex; gap:5px;"><input type="number" id="up-t1" class="inp-txt" placeholder="T1%"><input type="number" id="up-wr" class="inp-txt" placeholder="Wr%"><input type="number" id="up-pr" class="inp-txt" placeholder="Pr%"><input type="number" id="up-sa" class="inp-txt" placeholder="An%"></div>
        </div>
        <div class="set-box" style="border-color:var(--primary)">
            <div class="set-title">üìù Edit Subjects</div>
            <div style="font-size:11px; color:var(--error); margin-bottom:8px; font-weight:600">‚ö†Ô∏è Note: Renaming a subject hides marks saved under the old name.</div>
            <label style="font-size:11px; font-weight:700">Class 1 & 2</label>
            <div class="dual-sub-grid"><textarea id="sub-en-1" class="inp-txt" rows="3" placeholder="English" oninput="chkSubMatch(1)"></textarea><textarea id="sub-od-1" class="inp-txt" rows="3" placeholder="Odia" oninput="chkSubMatch(1)"></textarea></div>
            <div id="sm-1" class="sub-match-ui">Checking...</div>
            <label style="font-size:11px; font-weight:700">Class 3, 4 & 5</label>
            <div class="dual-sub-grid"><textarea id="sub-en-3" class="inp-txt" rows="3" placeholder="English" oninput="chkSubMatch(3)"></textarea><textarea id="sub-od-3" class="inp-txt" rows="3" placeholder="Odia" oninput="chkSubMatch(3)"></textarea></div>
            <div id="sm-3" class="sub-match-ui">Checking...</div>
            <label style="font-size:11px; font-weight:700">Class 6, 7 & 8</label>
            <div class="dual-sub-grid"><textarea id="sub-en-6" class="inp-txt" rows="4" placeholder="English" oninput="chkSubMatch(6)"></textarea><textarea id="sub-od-6" class="inp-txt" rows="4" placeholder="Odia" oninput="chkSubMatch(6)"></textarea></div>
            <div id="sm-6" class="sub-match-ui">Checking...</div>
        </div>
        <button class="btn-save" onclick="saveSettings()">SAVE SETTINGS</button>
    </div>
</div>

<div class="modal" id="mod-abt">
    <div class="modal-head"><span style="font-weight:700">About</span><button class="menu-icon" onclick="closeModal('mod-abt')" style="margin:0">‚úï</button></div>
    <div class="modal-body">
        <div style="text-align:center; margin-bottom:20px;">
            <h2 style="color:var(--primary); margin:10px 0;">Assess Offline</h2>
            <p style="opacity:0.7">v4.1 (Final Stable)</p>
            <p style="font-weight:600">Developed by Sahil Kumar Rout</p>
        </div>
        <div class="legal-box" style="background:var(--warn-bg); color:var(--text); border:1px solid var(--warn); padding:15px; border-radius:8px; margin-bottom:20px;"><strong>‚ö†Ô∏è DISCLAIMER</strong><br>This is an independent open-source project. It is <strong>NOT</strong> a Government app and is <strong>NOT</strong> developed, funded, or endorsed by any Government entity.</div>
        <div class="sec-title">CONTACT / SUPPORT</div><div style="font-size:13px; color:var(--text); margin-bottom:20px;">For bugs or suggestions, please contact the developer.<br><strong>License:</strong> MIT License (Free & Open Source).</div>
        <div class="legal-box" style="font-size:12px; color:var(--text-sec); border:1px solid var(--border); padding:12px; border-radius:8px;"><strong>PRIVACY POLICY</strong><br>1. <strong>Local Storage:</strong> All data is stored locally on your device.<br>2. <strong>No Collection:</strong> We collect ZERO personal information.<br>3. <strong>Data Safety:</strong> Use "Backup Data" weekly.</div>
    </div>
</div>

<div class="cfm-overlay" id="cfm-save"><div class="cfm-box"><h3>Incomplete?</h3><p style="color:var(--text-sec)">Empty boxes will cause "Incomplete" status.</p><div style="display:flex; gap:10px; margin-top:20px;"><button class="btn-save" style="background:var(--bg); color:var(--text); flex:1; margin:0; box-shadow:none" onclick="document.getElementById('cfm-save').style.display='none'">Back</button><button class="btn-save" style="flex:1; margin:0" onclick="confirmSave()">Save Anyway</button></div></div></div>
<div id="toast-box"></div><div id="print-wrap"></div>

<script>
// --- CORE CONFIG ---
const MAX_CLS = 8;
const CFG = { school: "", udise: "", session: "2025-26", lang: "od", lm: { fa:25, sa:50, wr:10, pr:20 }, pr: { t1:30, wr:10, pr:20, sa:40 }, up: { t1:30, wr:5, pr:15, sa:50 } };
const DEF_EN = { 1: "Language (Odia), Mathematics, EVS, Drawing", 3: "Language (Odia), Mathematics, English, EVS, Drawing", 6: "Language (Odia), Mathematics, English, Science, History & Civics, Geography, Hindi, Sanskrit, Drawing" };
const DEF_OD = { 1: "‡¨≠‡¨æ‡¨∑‡¨æ (‡¨ì‡¨°‡¨º‡¨ø‡¨Ü), ‡¨ó‡¨£‡¨ø‡¨§, ‡¨™‡¨∞‡¨ø‡¨¨‡≠á‡¨∂ ‡¨¨‡¨ø‡¨ú‡≠ç‡¨û‡¨æ‡¨®, ‡¨ö‡¨ø‡¨§‡≠ç‡¨∞‡¨æ‡¨ô‡≠ç‡¨ï‡¨®", 3: "‡¨≠‡¨æ‡¨∑‡¨æ (‡¨ì‡¨°‡¨º‡¨ø‡¨Ü), ‡¨ó‡¨£‡¨ø‡¨§, ‡¨á‡¨Ç‡¨∞‡¨æ‡¨ú‡≠Ä, ‡¨™‡¨∞‡¨ø‡¨¨‡≠á‡¨∂ ‡¨¨‡¨ø‡¨ú‡≠ç‡¨û‡¨æ‡¨®, ‡¨ö‡¨ø‡¨§‡≠ç‡¨∞‡¨æ‡¨ô‡≠ç‡¨ï‡¨®", 6: "‡¨≠‡¨æ‡¨∑‡¨æ (‡¨ì‡¨°‡¨º‡¨ø‡¨Ü), ‡¨ó‡¨£‡¨ø‡¨§, ‡¨á‡¨Ç‡¨∞‡¨æ‡¨ú‡≠Ä, ‡¨¨‡¨ø‡¨ú‡≠ç‡¨û‡¨æ‡¨®, ‡¨á‡¨§‡¨ø‡¨π‡¨æ‡¨∏ ‡¨ì ‡¨®‡¨æ‡¨ó‡¨∞‡≠Ä‡¨ï ‡¨®‡≠Ä‡¨§‡¨ø, ‡¨≠‡≠Ç‡¨ó‡≠ã‡¨≥, ‡¨π‡¨ø‡¨®‡≠ç‡¨¶‡≠Ä, ‡¨∏‡¨Ç‡¨∏‡≠ç‡¨ï‡≠É‡¨§, ‡¨ö‡¨ø‡¨§‡≠ç‡¨∞‡¨æ‡¨ô‡≠ç‡¨ï‡¨®" };
const TR = { en: { n:"Name Of The Student", s:"Subject", t1:"(FA-1 + FA-2 + SA-1)", wgt:"SCORE @ [x]% weightage", asn:"Assignment", prj:"Project", sa2:"SA-2 / Annual Exam", tot:"TOTAL SCORE (SUBJECT)", gt:"GRAND TOTAL SCORE", pct:"GT SCORE %", best:"Best" }, od: { n:"‡¨∂‡¨ø‡¨ï‡≠ç‡¨∑‡¨æ‡¨∞‡≠ç‡¨•‡≠Ä‡¨∞ ‡¨®‡¨æ‡¨Æ", s:"‡¨¨‡¨ø‡¨∑‡≠ü", t1:"(FA-1 + FA-2 + SA-1)", wgt:"‡¨™‡≠ç‡¨∞‡¨æ‡¨™‡≠ç‡¨§‡¨æ‡¨ô‡≠ç‡¨ï @ [x]% ‡¨ó‡≠Å‡¨∞‡≠Å‡¨§‡≠ç‡¨µ", asn:"‡¨≤‡¨ø‡¨ñ‡¨ø‡¨§ ‡¨ï‡¨æ‡¨∞‡≠ç‡¨Ø‡≠ç‡≠ü", prj:"‡¨™‡≠ç‡¨∞‡¨ï‡¨≥‡≠ç‡¨™ ‡¨ï‡¨æ‡¨∞‡≠ç‡¨Ø‡≠ç‡≠ü", sa2:"SA-2 / ‡¨¨‡¨æ‡¨∞‡≠ç‡¨∑‡¨ø‡¨ï ‡¨™‡¨∞‡≠Ä‡¨ï‡≠ç‡¨∑‡¨æ", tot:"‡¨Æ‡≠ã‡¨ü ‡¨™‡≠ç‡¨∞‡¨æ‡¨™‡≠ç‡¨∞‡¨æ‡¨ô‡≠ç‡¨ï (‡¨¨‡¨ø‡¨∑‡≠ü)", gt:"‡¨∏‡¨∞‡≠ç‡¨¨‡¨Æ‡≠ã‡¨ü ‡¨™‡≠ç‡¨∞‡¨æ‡¨™‡≠ç‡¨§‡¨æ‡¨ô‡≠ç‡¨ï", pct:"% ‡¨∏‡¨∞‡≠ç‡¨¨‡¨Æ‡≠ã‡¨ü ‡¨™‡≠ç‡¨∞‡¨æ‡¨™‡≠ç‡¨§‡¨æ‡¨ô‡≠ç‡¨ï", best:"‡¨∂‡≠ç‡¨∞‡≠á‡¨∑‡≠ç‡¨†" } };

let db = { cf: JSON.parse(JSON.stringify(CFG)), st: {} };
let cls = "1"; let eIdx = null; let isSelMode = false; let selIds = new Set(); let pendingNext = false; 

// --- SECURITY & UTILS ---
function sanitize(str) { if(!str) return ""; return str.replace(/</g, "&lt;").replace(/>/g, "&gt;"); }

// --- INIT ---
function init() {
    let th = localStorage.getItem("theme"); if(th === "dark") { document.body.classList.add("dark"); } updThemeBtn();
    let s = localStorage.getItem("assess_v2_gold");
    if(s) {
        try {
            let ld = JSON.parse(s); db.cf = {...CFG, ...ld.cf}; db.st = ld.st || {};
            if(!db.cf.lm) db.cf.lm={...CFG.lm}; if(!db.cf.pr) db.cf.pr={...CFG.pr}; if(!db.cf.up) db.cf.up={...CFG.up};
            if(!db.cf.subEn) { if(db.cf.subs) { db.cf.subEn=db.cf.subs; db.cf.subOd={...DEF_OD}; delete db.cf.subs; } else { db.cf.subEn={...DEF_EN}; db.cf.subOd={...DEF_OD}; } save(); }
            for(let i=1; i<=MAX_CLS; i++) if(!db.st[i]) db.st[i] = [];
        } catch(e) { alert("Data Corrupted. App reset safely."); for(let i=1; i<=MAX_CLS; i++) db.st[i] = []; db.cf.subEn={...DEF_EN}; db.cf.subOd={...DEF_OD}; }
    } else { for(let i=1; i<=MAX_CLS; i++) db.st[i] = []; db.cf.subEn={...DEF_EN}; db.cf.subOd={...DEF_OD}; }
    try { if(document.getElementById('menu-school')) document.getElementById('menu-school').value = db.cf.school || ""; if(document.getElementById('menu-udise')) document.getElementById('menu-udise').value = db.cf.udise || ""; if(document.getElementById('menu-ses')) document.getElementById('menu-ses').value = db.cf.session || ""; } catch(e) {}
    renderMenu(); renderList(); updUI();
}
function save() { localStorage.setItem("assess_v2_gold", JSON.stringify(db)); renderMenu(); renderList(); }
function toast(m) { let b=document.getElementById('toast-box'), t=document.createElement('div'); t.className='toast'; t.innerText=m; b.appendChild(t); setTimeout(()=>t.classList.add('show'),10); setTimeout(()=>{t.classList.remove('show');setTimeout(()=>t.remove(),300)},2500); }
function toggleDrawer() { let d=document.getElementById('drawer'),o=document.getElementById('overlay'); if(d.classList.contains('open')){d.classList.remove('open');o.classList.remove('show');setTimeout(()=>o.style.display='none',300)}else{o.style.display='block';setTimeout(()=>o.classList.add('show'),10);d.classList.add('open')} }
function toggleDark() { document.body.classList.toggle('dark'); localStorage.setItem("theme", document.body.classList.contains('dark') ? "dark" : "light"); updThemeBtn(); }
function updThemeBtn() { let isDark = document.body.classList.contains('dark'); document.getElementById('theme-btn').innerText = isDark ? "Current Theme: Dark üåô" : "Current Theme: Light ‚òÄÔ∏è"; }
function updCF(k,v) { db.cf[k]=v; save(); updUI(); }
function updUI() { document.getElementById('ui-school').innerText=db.cf.school||"My Govt School"; document.getElementById('ui-class').innerText=`Class ${cls} Register`; }

// --- ACTIONS ---
function toggleSelMode() { isSelMode = !isSelMode; selIds.clear(); document.getElementById('sel-toggle').classList.toggle('active'); document.body.classList.toggle('sel-mode'); renderList(); updSelUI(); }
function toggleSel(idx) { if(selIds.has(idx)) selIds.delete(idx); else selIds.add(idx); renderList(); updSelUI(); }
function updSelUI() { document.getElementById('sel-count').innerText = `${selIds.size} Selected`; }
function deleteSelected() { if(selIds.size===0) return toast("Select first"); if(confirm(`Delete ${selIds.size} students?`)) { let sorted = Array.from(selIds).sort((a,b)=>b-a); sorted.forEach(idx => db.st[cls].splice(idx, 1)); toggleSelMode(); save(); toast("Deleted"); } }

function renderMenu() {
    // FIX: Clear selection when rendering menu/switching classes
    selIds.clear(); isSelMode=false; document.body.classList.remove('sel-mode'); document.getElementById('sel-toggle').classList.remove('active');
    let m = document.getElementById('menu-cls-list'); m.innerHTML = "";
    for(let i=1; i<=MAX_CLS; i++) {
        let d = db.st[i]||[]; let comp = d.filter(s => checkComp(s, i)).length;
        let div = document.createElement('div'); div.className = "menu-item" + (i.toString()===cls ? " active-cls" : "");
        div.innerHTML = `<span>Class ${i}</span><span class="count-badge ${comp===d.length && d.length>0 ? 'done':''}">${comp}/${d.length}</span>`;
        div.onclick = () => { cls=i.toString(); closeModal('mod-edit'); toggleDrawer(); renderMenu(); renderList(); updUI(); };
        m.appendChild(div);
    }
}
function renderList() {
    let l = document.getElementById('list'); l.innerHTML = ""; let data = db.st[cls]||[];
    if(data.length===0) { l.innerHTML=`<div class="empty-state"><div class="empty-icon">üìÇ</div><div>No students in Class ${cls}.<br>Tap <b>+ Add Student</b> to start.</div></div>`; return; }
    data.forEach((s, i) => {
        let res = calcStudent(s, cls); let tag = res.complete ? `<span class="tag com">‚úÖ Completed</span>` : `<span class="tag inc">‚ö†Ô∏è Incomplete</span>`;
        let d = document.createElement('div'); d.className = "card" + (res.complete ? " pass" : "");
        let chkHTML = `<div class="sel-chk ${selIds.has(i)?'checked':''}">‚úì</div>`;
        // FIX: XSS Protection using sanitize()
        d.innerHTML = `${chkHTML}<div class="card-content"><div class="row-top"><div class="st-name">${i+1}. ${sanitize(s.name)}</div><div class="st-score">${res.gt} <span style="font-size:11px;font-weight:400;color:var(--text-sec)">(${res.pct}%)</span></div></div><div class="tags">${tag}</div></div>`;
        d.onclick = () => { if(isSelMode) toggleSel(i); else editStudent(i); };
        l.appendChild(d);
    });
}

function getSubs(c, langOverride) { let n = parseInt(c); let lang = langOverride || db.cf.lang; let src = (lang === 'od') ? db.cf.subOd : db.cf.subEn; let list = ""; if(n>=6) list = src[6]; else if(n>=3) list = src[3]; else list = src[1]; return list.split(',').map(x=>x.trim()).filter(x=>x); }
function checkComp(s, c) { if(!s.m) return false; let subs = getSubs(c, 'en'); let L = db.cf.lm; for(let sb of subs) { let mk = s.m?.[sb] ?? {}; let keys = ['f1','f2','s1','s2']; if(L.wr > 0) keys.push('a1','a2'); if(L.pr > 0) keys.push('p1','p2'); for(let k of keys) if(mk[k]==="" || mk[k]===undefined) return false; } return true; }
function getWeights(c) { return parseInt(c)<=5 ? db.cf.pr : db.cf.up; }
function calcStudent(s, c) {
    // --- CALCULATION LOGIC (Editable Area) ---
    let subs = getSubs(c, 'en'); let W = getWeights(c); let L = db.cf.lm; let gt = 0, complete = true;
    subs.forEach(sb => {
        let m = s.m?.[sb] ?? {}; if(!checkComp(s,c)) complete=false; let n = v => parseFloat(v)||0;
        let maxT1 = (L.fa*2)+L.sa; 
        let term1 = maxT1>0 ? ((n(m.f1)+n(m.f2)+n(m.s1)) / maxT1) * W.t1 : 0;
        let assess = L.wr>0 ? (Math.max(n(m.a1), n(m.a2)) / L.wr) * W.wr : 0;
        let project = L.pr>0 ? (Math.max(n(m.p1), n(m.p2)) / L.pr) * W.pr : 0;
        let term2 = L.sa>0 ? (n(m.s2) / L.sa) * W.sa : 0;
        gt += Math.ceil(term1 + assess + project + term2); // Rounding UP as requested
    });
    let pct = subs.length ? ((gt / (subs.length*100))*100).toFixed(1) : 0; return { gt, pct, complete };
}

// --- EDIT (GRID OPTIMIZED - TETRIS) ---
function editStudent(idx) {
    eIdx = idx; let s = (idx===null) ? {name:"", m:{}} : db.st[cls][idx];
    document.getElementById('edit-title').innerText = idx===null ? "Add Student" : "Edit Student";
    document.getElementById('inp-name').value = s.name;
    document.getElementById('mod-edit').style.display = 'block';
    document.getElementById('btn-del').style.display = idx===null ? 'none' : 'block';
    let box = document.getElementById('marks-area'); box.innerHTML = "";
    let subs = getSubs(cls, 'en'); let L = db.cf.lm;
    subs.forEach(sb => {
        let m = s.m?.[sb] ?? {};
        let html = `<div class="sub-card"><div class="sub-head">${sb}</div><div class="mark-grid">
            <div class="mark-cell"><label>FA1 /${L.fa}</label><input type="text" inputmode="decimal" class="mark-inp" value="${m.f1||''}" data-s="${sb}" data-k="f1" data-mx="${L.fa}" oninput="chk(this)"></div>
            <div class="mark-cell"><label>FA2 /${L.fa}</label><input type="text" inputmode="decimal" class="mark-inp" value="${m.f2||''}" data-s="${sb}" data-k="f2" data-mx="${L.fa}" oninput="chk(this)"></div>
            <div class="mark-cell"><label>SA1 /${L.sa}</label><input type="text" inputmode="decimal" class="mark-inp" value="${m.s1||''}" data-s="${sb}" data-k="s1" data-mx="${L.sa}" oninput="chk(this)"></div>`;
        if(L.wr > 0) {
            html += `<div class="mark-cell"><label>Assign 1 /${L.wr}</label><input type="text" inputmode="decimal" class="mark-inp" value="${m.a1||''}" data-s="${sb}" data-k="a1" data-mx="${L.wr}" oninput="chk(this)"></div>
            <div class="mark-cell"><label>Assign 2 /${L.wr}</label><input type="text" inputmode="decimal" class="mark-inp" value="${m.a2||''}" data-s="${sb}" data-k="a2" data-mx="${L.wr}" oninput="chk(this)"></div>`;
        }
        if(L.pr > 0) {
            html += `<div class="mark-cell"><label>Project 1 /${L.pr}</label><input type="text" inputmode="decimal" class="mark-inp" value="${m.p1||''}" data-s="${sb}" data-k="p1" data-mx="${L.pr}" oninput="chk(this)"></div>
            <div class="mark-cell"><label>Project 2 /${L.pr}</label><input type="text" inputmode="decimal" class="mark-inp" value="${m.p2||''}" data-s="${sb}" data-k="p2" data-mx="${L.pr}" oninput="chk(this)"></div>`;
        }
        // SA2 spans 2 columns to fit nicely
        html += `<div class="mark-cell" style="grid-column: span 2"><label>SA2 (Annual) /${L.sa}</label><input type="text" inputmode="decimal" class="mark-inp" value="${m.s2||''}" data-s="${sb}" data-k="s2" data-mx="${L.sa}" oninput="chk(this)"></div></div></div>`;
        box.innerHTML += html;
    });
}
function chk(el) { let mx = parseFloat(el.dataset.mx); if(parseFloat(el.value)>mx) { toast(`Max is ${mx}`); el.value=""; el.style.borderColor="var(--error)"; } else el.style.borderColor="var(--border)"; }
function preSaveCheck(isNext) { pendingNext = isNext; let empty = false; document.querySelectorAll('.mark-inp').forEach(i => { if(i.value==="") empty=true; }); if(empty) document.getElementById('cfm-save').style.display = 'flex'; else confirmSave(); }
function confirmSave() {
    let n = document.getElementById('inp-name').value.toUpperCase().trim(); if(!n) return toast("Name required");
    let marks = {}; document.querySelectorAll('.mark-inp').forEach(i => { let s = i.dataset.s, k = i.dataset.k; if(!marks[s]) marks[s] = {}; marks[s][k] = i.value; });
    // Sanitize Name
    let obj = { name:sanitize(n), m:marks }; if(eIdx===null) db.st[cls].push(obj); else db.st[cls][eIdx] = obj;
    document.getElementById('cfm-save').style.display='none'; save(); 
    if(pendingNext) { toast("Saved. Next Student."); eIdx = null; document.getElementById('edit-title').innerText = "Add Student"; document.getElementById('inp-name').value = ""; document.querySelectorAll('.mark-inp').forEach(i => i.value=""); document.getElementById('inp-name').focus(); document.getElementById('btn-del').style.display = 'none'; } 
    else { closeModal('mod-edit'); toast("Saved"); renderList(); }
}
function delStudent() { if(confirm("Delete Student?")) { db.st[cls].splice(eIdx,1); save(); closeModal('mod-edit'); toast("Deleted"); } }
function checkUnsaved() { if(confirm("Discard changes?")) closeModal('mod-edit'); }

// --- SETTINGS (CRASH PROOF) ---
function openSettings() {
    try {
        if (!db.cf.subEn || !db.cf.subOd) { db.cf.subEn = db.cf.subEn || {...DEF_EN}; db.cf.subOd = db.cf.subOd || {...DEF_OD}; save(); }
        const sv = (id, v) => { let el = document.getElementById(id); if(el) el.value = v; };
        sv('cfg-lang', db.cf.lang);
        let L = db.cf.lm || { fa:25, sa:50, wr:10, pr:10 }; let P = db.cf.pr || { t1:30, wr:10, pr:20, sa:40 }; let U = db.cf.up || { t1:30, wr:5, pr:15, sa:50 };
        if(document.getElementById('lm-fa')) {
            sv('lm-fa', L.fa); sv('lm-sa', L.sa); sv('lm-wr', L.wr); sv('lm-pr', L.pr);
            sv('pr-t1', P.t1); sv('pr-wr', P.wr); sv('pr-pr', P.pr); sv('pr-sa', P.sa);
            sv('up-t1', U.t1); sv('up-wr', U.wr); sv('up-pr', U.pr); sv('up-sa', U.sa);
            [1,3,6].forEach(k => {
                let enTxt = (db.cf.subEn && db.cf.subEn[k]) ? db.cf.subEn[k] : ""; let odTxt = (db.cf.subOd && db.cf.subOd[k]) ? db.cf.subOd[k] : "";
                sv('sub-en-'+k, enTxt); sv('sub-od-'+k, odTxt);
                if(document.getElementById('sub-en-'+k)) chkSubMatch(k); 
            });
        }
        if(document.getElementById('drawer').classList.contains('open')) toggleDrawer();
        document.getElementById('mod-set').style.display='block';
    } catch(e) { alert("Settings Error: " + e.message); }
}
function chkSubMatch(k) {
    try {
        let elEn = document.getElementById('sub-en-'+k); let elOd = document.getElementById('sub-od-'+k); if(!elEn || !elOd) return;
        let en = elEn.value.split(',').filter(x=>x.trim()); let od = elOd.value.split(',').filter(x=>x.trim());
        let ui = document.getElementById('sm-'+k);
        if(ui) { ui.innerText = `English: ${en.length} | Odia: ${od.length} - ${en.length===od.length ? 'Match ‚úÖ' : 'Mismatch ‚ùå'}`; ui.className = en.length===od.length ? "sub-match-ui ok" : "sub-match-ui bad"; }
    } catch(e) {}
}
function saveSettings() {
    db.cf.lang = document.getElementById('cfg-lang').value;
    let L=db.cf.lm, P=db.cf.pr, U=db.cf.up;
    if(document.getElementById('lm-fa')) {
        L.fa=p(document.getElementById('lm-fa')); L.sa=p(document.getElementById('lm-sa')); L.wr=p(document.getElementById('lm-wr')); L.pr=p(document.getElementById('lm-pr'));
        P.t1=p(document.getElementById('pr-t1')); P.wr=p(document.getElementById('pr-wr')); P.pr=p(document.getElementById('pr-pr')); P.sa=p(document.getElementById('pr-sa'));
        U.t1=p(document.getElementById('up-t1')); U.wr=p(document.getElementById('up-wr')); U.pr=p(document.getElementById('up-pr')); U.sa=p(document.getElementById('up-sa'));
        [1,3,6].forEach(k => { db.cf.subEn[k] = document.getElementById('sub-en-'+k).value; db.cf.subOd[k] = document.getElementById('sub-od-'+k).value; });
    }
    save(); closeModal('mod-set'); toast("Updated"); renderList(); 
}
function p(el) { return parseInt(el.value)||0; }
function closeModal(id) { document.getElementById(id).style.display='none'; }
function openAbout() { if(document.getElementById('drawer').classList.contains('open')) toggleDrawer(); document.getElementById('mod-abt').style.display='block'; }

// --- BACKUP ---
function backupData() { let d = new Date().toISOString().slice(0,10); let fname = `!_Assess_Backup_${d}.json`; let a=document.createElement('a'); a.href="data:text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(db)); a.download=fname; a.click(); }
function restoreData(i) { 
    let f=i.files[0]; if(!f) return; let r=new FileReader(); 
    r.onload=(e)=>{
        try {
            let obj = JSON.parse(e.target.result);
            if(!obj.cf || !obj.st) throw new Error("Invalid Backup File");
            // Sanity Loop on Restore
            for(let k=1; k<=MAX_CLS; k++) if(!Array.isArray(obj.st[k])) obj.st[k] = [];
                // 1. Load the old data    
                db = obj;
                // 2. FORCE update the Limits to your new defaults (20)
                // This ignores the old '10' from the backup file
                db.cf.lm = JSON.parse(JSON.stringify(CFG.lm));
                // 3. Save and Reload
                save(); alert("Restore Successful"); location.reload();
        } catch(err) { alert("Error: " + err.message); }
    }; r.readAsText(f); 
}
function resetAll() { if(confirm("FACTORY RESET: All data will be lost. Confirm?")) { localStorage.removeItem("assess_v2_gold"); location.reload(); } }

function prepExport(mode) {
    try {
        let oldTitle = document.title;
        let classPart = (mode === 'all') ? "All class" : `Class ${cls}`;
        let session = db.cf.session || "";
        let udise = db.cf.udise ? ` (${db.cf.udise})` : ""; 
        document.title = `${classPart} (${session}) Mark Register${udise}`;
        let T = TR[db.cf.lang]; let h = "";
        if(mode==='single') h = getHTML(cls, true, T);
        else for(let i=1;i<=MAX_CLS;i++) { let t=getHTML(i.toString(), true, T); if(t) h+=`<div class="page-break"></div>`+t; }
        if(!h) { document.title = oldTitle; return toast("No Data Found"); }
        let pWrap = document.getElementById('print-wrap'); pWrap.innerHTML = h;
        setTimeout(() => { window.print(); document.title = oldTitle; }, 500);
    } catch(e) { alert("PDF Error: " + e.message); }
}

function getHTML(c, header, T) {
    let d = db.st[c]||[]; if(d.length===0) return "";
    let sbsEn = getSubs(c, 'en'); let sbsOd = getSubs(c, 'od'); 
    let W = getWeights(c), L = db.cf.lm;
    let sbs = (db.cf.lang==='od') ? sbsOd : sbsEn; 
    let hT1=T.wgt.replace('[x]',W.t1), hWr=T.wgt.replace('[x]',W.wr);
    let hPr=T.wgt.replace('[x]',W.pr), hSa=T.wgt.replace('[x]',W.sa);
    let h = header ? `<div class="p-head"><div class="p-school">${db.cf.school}</div><div style="font-size:12pt; font-weight:bold">MARK REGISTER ${db.cf.session} | CLASS: ${c} | UDISE: ${db.cf.udise}</div></div>` : "";
    h += `<table><thead><tr>
    <th rowspan="2" style="width:30px">Sl.</th><th rowspan="2" class="t-left" style="width:120px">${T.n}</th><th rowspan="2" class="t-left" style="width:80px">${T.s}</th>
    <th class="v-th"><div class="v-txt">FA-1</div></th><th class="v-th"><div class="v-txt">FA-2</div></th><th class="v-th"><div class="v-txt">SA-1</div></th>
    <th class="v-th"><div class="v-txt">${T.t1}</div></th><th class="v-th"><div class="v-txt">${hT1}</div></th>
    <th class="v-th"><div class="v-txt">${T.asn} 1</div></th><th class="v-th"><div class="v-txt">${T.asn} 2</div></th><th class="v-th"><div class="v-txt">${T.best}</div></th><th class="v-th"><div class="v-txt">${hWr}</div></th>
    <th class="v-th"><div class="v-txt">${T.prj} 1</div></th><th class="v-th"><div class="v-txt">${T.prj} 2</div></th><th class="v-th"><div class="v-txt">${T.best}</div></th><th class="v-th"><div class="v-txt">${hPr}</div></th>
    <th class="v-th"><div class="v-txt">${T.sa2}</div></th><th class="v-th"><div class="v-txt">${hSa}</div></th>
    <th class="v-th"><div class="v-txt">${T.tot}</div></th>
    <th rowspan="2"><div class="v-txt" style="font-size:10pt; font-weight:bold">${T.gt}</div></th><th rowspan="2"><div class="v-txt" style="font-size:10pt; font-weight:bold">${T.pct}</div></th>
    </tr><tr>
    <th>${L.fa}</th><th>${L.fa}</th><th>${L.sa}</th><th>100</th><th>${W.t1}%</th>
    <th>${L.wr}</th><th>${L.wr}</th><th>${L.wr}</th><th>${W.wr}%</th>
    <th>${L.pr}</th><th>${L.pr}</th><th>${L.pr}</th><th>${W.pr}%</th>
    <th>${L.sa}</th><th>${W.sa}%</th><th>100</th>
    </tr></thead><tbody>`;
    d.forEach((s, idx) => {
        let gt = 0, subRows = "", n = v => parseFloat(v)||0;
        sbsEn.forEach((sbKey, sbIdx) => {
            let m = s.m?.[sbKey] ?? {};
            let sumT1 = n(m.f1)+n(m.f2)+n(m.s1); let maxT1 = (L.fa*2)+L.sa; 
            // Human-Readable Calculation Block
            let term1 = maxT1>0 ? (sumT1/maxT1)*W.t1 : 0;
            let assess = L.wr>0 ? (Math.max(n(m.a1), n(m.a2))/L.wr)*W.wr : 0;
            let project = L.pr>0 ? (Math.max(n(m.p1), n(m.p2))/L.pr)*W.pr : 0;
            let term2 = L.sa>0 ? (n(m.s2)/L.sa)*W.sa : 0;
            let fin = Math.ceil(term1+assess+project+term2); gt += fin;
            subRows += `<tr><td class="t-left">${sbs[sbIdx]||sbKey}</td><td>${m.f1||0}</td><td>${m.f2||0}</td><td>${m.s1||0}</td><td><b>${sumT1}</b></td><td>${term1.toFixed(1)}</td><td>${m.a1||0}</td><td>${m.a2||0}</td><td>${Math.max(n(m.a1),n(m.a2))}</td><td>${assess.toFixed(1)}</td><td>${m.p1||0}</td><td>${m.p2||0}</td><td>${Math.max(n(m.p1),n(m.p2))}</td><td>${project.toFixed(1)}</td><td>${m.s2||0}</td><td>${term2.toFixed(1)}</td><td style="font-weight:bold">${fin}</td></tr>`;
        });
        let rows = subRows.split('</tr>'); rows.pop();
        rows.forEach((r,ri) => {
            h += `<tr>`;
            if(ri===0) h += `<td rowspan="${sbs.length}">${idx+1}</td><td rowspan="${sbs.length}" class="t-left"><b>${sanitize(s.name)}</b></td>`;
            h += r.replace('<tr>','');
            if(ri===0) { let pct = sbs.length ? ((gt/(sbs.length*100))*100).toFixed(1) : 0; h += `<td rowspan="${sbs.length}" class="gt-cell">${gt}</td><td rowspan="${sbs.length}" class="gt-cell">${pct}%</td>`; }
            h += `</tr>`;
        });
    });
    return h + "</tbody></table>";
}

function genExcel() {
    let d = db.st[cls]||[]; if(d.length===0) return toast("Empty Class");
    let t = getHTML(cls, false, TR[db.cf.lang]);
    let content = `<html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns="http://www.w3.org/TR/REC-html40"><head><meta charset="UTF-8"></head><body><h3>${db.cf.school} - Class ${cls}</h3>${t}</body></html>`;
    let blob = new Blob(["\uFEFF"+content], {type: 'application/vnd.ms-excel;charset=utf-8'});
    let url = URL.createObjectURL(blob); let a = document.createElement('a'); a.href = url; a.download = `Register_${cls}.xls`;
    document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
}

init();
</script>
<script>
(function(){
    try {
        // 1. Find the Contact Section inside About Modal
        var abt = document.getElementById('mod-abt');
        var targets = abt.getElementsByTagName('div');
        
        for(var i = 0; i < targets.length; i++) {
            // Locate the specific text block
            if(targets[i].innerHTML.includes('For bugs or suggestions')) {
                
                // 2. Define Premium Links HTML
                var linksHTML = `
                <div style="margin-top:12px; padding-top:12px; border-top:1px dashed var(--border);">
                    <div style="font-size:11px; font-weight:700; color:var(--text-sec); margin-bottom:8px; text-transform:uppercase;">Community & Updates</div>
                    
                    <a href="https://t.me/+pV0H_iNurNAyMmZl" target="_blank" 
                       style="display:flex; align-items:center; gap:8px; text-decoration:none; color:var(--text); background:var(--zebra); padding:10px; border-radius:8px; margin-bottom:8px; border:1px solid var(--border);">
                       <span style="font-size:18px;">üë•</span>
                       <div>
                           <div style="font-weight:600; font-size:13px;">Join Support Group</div>
                           <div style="font-size:10px; opacity:0.7;">Get help & discuss features</div>
                       </div>
                    </a>

                    <a href="https://t.me/assess_offline_channel" target="_blank" 
                       style="display:flex; align-items:center; gap:8px; text-decoration:none; color:var(--text); background:var(--zebra); padding:10px; border-radius:8px; border:1px solid var(--border);">
                       <span style="font-size:18px;">üì¢</span>
                       <div>
                           <div style="font-weight:600; font-size:13px;">Follow Channel</div>
                           <div style="font-size:10px; opacity:0.7;">@assess_offline_channel</div>
                       </div>
                    </a>
                </div>`;

                // 3. Inject safely
                targets[i].insertAdjacentHTML('beforeend', linksHTML);
                break; // Stop once found
            }
        }
    } catch(e) { console.log("Patch Skipped"); }
})();
</script>
</body>
</html>