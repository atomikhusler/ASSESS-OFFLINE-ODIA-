<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Assess Offline v2.6</title>
<style>
    /* --- THEME VARIABLES (Light Default) --- */
    :root {
        --primary: #0b57d0; --on-primary: #ffffff; --bg: #f0f2f5; --surface: #ffffff;
        --text: #1f1f1f; --text-sec: #5e5e5e; --border: #e0e0e0;
        --success: #146c2e; --success-bg: #c4eed0; --warn: #b96400; --warn-bg: #ffefc2;
        --error: #b3261e; --error-bg: #f9dedc; --shadow: 0 2px 8px rgba(0,0,0,0.08);
        --strip: #e1e3e1; --strip-text: #444746;
    }
    body.dark {
        --primary: #a8c7fa; --on-primary: #062e6f; --bg: #121212; --surface: #1e1f20;
        --text: #e3e3e3; --text-sec: #c4c7c5; --border: #444746;
        --success: #6dd58c; --success-bg: #0f5223; --warn: #ffb951; --warn-bg: #4a2800;
        --error: #f2b8b5; --error-bg: #601410; --shadow: 0 4px 12px rgba(0,0,0,0.4);
        --strip: #2d2f31; --strip-text: #c4c7c5;
    }
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
    body { font-family: 'Segoe UI', 'Roboto', sans-serif; margin: 0; background: var(--bg); color: var(--text); padding-top: 100px; padding-bottom: 90px; transition: background 0.3s, color 0.3s; }
    button { cursor: pointer; user-select: none; font-family: inherit; }

    /* --- LAYOUT & HEADER --- */
    header {
        position: fixed; top: 0; left: 0; width: 100%; height: 60px;
        background: var(--surface); color: var(--text);
        display: flex; align-items: center; padding: 0 16px;
        z-index: 1000; box-shadow: 0 1px 4px rgba(0,0,0,0.1);
        border-bottom: 1px solid var(--border);
    }
    .brand-strip {
        position: fixed; top: 60px; left: 0; width: 100%; height: 28px;
        background: var(--strip); color: var(--strip-text);
        font-size: 11px; font-weight: 700; text-transform: uppercase;
        display: flex; align-items: center; justify-content: center;
        z-index: 990; letter-spacing: 0.5px;
    }
    .menu-icon { background: none; border: none; font-size: 24px; color: var(--text); padding: 8px; margin-right: 12px; border-radius: 50%; }
    .menu-icon:active { background: rgba(128,128,128,0.1); }
    .header-titles { flex: 1; overflow: hidden; }
    .header-titles h1 { margin: 0; font-size: 18px; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: var(--primary); }
    .header-titles p { margin: 0; font-size: 12px; color: var(--text-sec); }
    
    .btn-pdf {
        background: var(--primary); color: var(--on-primary); border: none;
        padding: 6px 14px; border-radius: 6px; font-size: 13px; font-weight: 600;
        display: flex; align-items: center; gap: 6px; box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    .btn-pdf:active { opacity: 0.9; transform: scale(0.97); }

    /* --- LIST & CARDS --- */
    .container { max-width: 800px; margin: 0 auto; padding: 10px 16px; min-height: 60vh; }
    .empty-state {
        display: flex; flex-direction: column; align-items: center; justify-content: center;
        height: 50vh; text-align: center; color: var(--text-sec); animation: fadeIn 0.5s;
    }
    .empty-icon { font-size: 48px; margin-bottom: 15px; opacity: 0.5; }
    
    .card {
        background: var(--surface); border-radius: 12px; padding: 16px; margin-bottom: 12px;
        box-shadow: var(--shadow); border: 1px solid var(--border);
        border-left: 5px solid transparent; position: relative; transition: transform 0.1s;
    }
    .card:active { transform: scale(0.98); }
    .card.pass { border-left-color: var(--success); }
    .card.fail { border-left-color: var(--error); }
    
    .row-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
    .st-name { font-size: 16px; font-weight: 600; color: var(--text); }
    .st-score-box { text-align: right; line-height: 1.1; }
    .st-score { font-size: 20px; font-weight: 800; color: var(--primary); }
    .st-percent { font-size: 11px; color: var(--text-sec); }
    
    .tags { display: flex; gap: 8px; font-size: 11px; font-weight: 700; }
    .tag { padding: 4px 10px; border-radius: 12px; }
    .tag.inc { background: var(--warn-bg); color: var(--warn); }
    .tag.com { background: var(--success-bg); color: var(--success); }

    /* --- FAB --- */
    .fab {
        position: fixed; bottom: 24px; right: 24px; width: 56px; height: 56px;
        background: var(--primary); color: var(--on-primary); border-radius: 16px; border: none;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3); font-size: 32px; z-index: 900;
        display: flex; justify-content: center; align-items: center; transition: transform 0.2s;
    }
    .fab:active { transform: scale(0.9); }

    /* --- DRAWER (MENU) --- */
    .overlay {
        display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.6); z-index: 1100; backdrop-filter: blur(3px); opacity: 0; transition: opacity 0.3s;
    }
    .overlay.show { opacity: 1; }
    .drawer {
        position: fixed; top: 0; left: 0; width: 280px; height: 100%;
        background: var(--surface); z-index: 1200; transform: translateX(-100%);
        transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        display: flex; flex-direction: column; border-right: 1px solid var(--border);
        box-shadow: 4px 0 16px rgba(0,0,0,0.2);
    }
    .drawer.open { transform: translateX(0); }
    .drawer-head {
        padding: 20px; background: var(--surface); border-bottom: 1px solid var(--border);
        display: flex; justify-content: space-between; align-items: center;
    }
    .drawer-body { flex: 1; overflow-y: auto; padding: 8px 0; }
    .sec-title { padding: 24px 20px 8px; font-size: 11px; font-weight: 700; color: var(--primary); text-transform: uppercase; letter-spacing: 1px; }
    .menu-item {
        padding: 14px 20px; font-size: 15px; display: flex; justify-content: space-between; align-items: center;
        cursor: pointer; color: var(--text); border-left: 4px solid transparent; transition: background 0.1s;
    }
    .menu-item:active { background: rgba(128,128,128,0.1); }
    .menu-item.active-cls { background: rgba(11, 87, 208, 0.08); color: var(--primary); font-weight: 600; border-left-color: var(--primary); }
    .count-badge { font-size: 12px; font-weight: 600; color: var(--text-sec); padding: 2px 6px; border-radius: 4px; background: rgba(128,128,128,0.1); }
    .count-badge.done { color: var(--success); background: var(--success-bg); }

    /* --- MODALS --- */
    .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg); z-index: 1500; overflow-y: auto; }
    .modal-head {
        position: sticky; top: 0; background: var(--surface); border-bottom: 1px solid var(--border);
        padding: 12px 16px; display: flex; justify-content: space-between; align-items: center; z-index: 1510;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .modal-body { padding: 20px; max-width: 600px; margin: 0 auto; padding-bottom: 80px; }
    .inp-grp { margin-bottom: 16px; }
    .inp-grp label { display: block; margin-bottom: 6px; font-size: 13px; font-weight: 600; color: var(--text-sec); }
    .inp-txt, select.inp-txt {
        width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 8px;
        font-size: 16px; background: var(--surface); color: var(--text); font-family: inherit;
    }
    .inp-txt:focus { border-color: var(--primary); border-width: 2px; padding: 11px; }

    /* SETTINGS BOXES */
    .set-box { background: var(--surface); border: 1px solid var(--border); border-radius: 8px; padding: 16px; margin-bottom: 16px; }
    .set-title { font-weight: 700; color: var(--primary); margin-bottom: 12px; font-size: 14px; display: flex; align-items: center; gap: 8px; }
    
    /* ENTRY GRID */
    .sub-card { background: var(--surface); border: 1px solid var(--border); border-radius: 10px; padding: 16px; margin-bottom: 16px; }
    .sub-head { font-weight: 700; color: var(--text); border-bottom: 2px solid var(--border); margin-bottom: 12px; padding-bottom: 6px; font-size: 16px; }
    .mark-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(70px, 1fr)); gap: 10px; margin-bottom: 10px; }
    .mark-cell { text-align: center; }
    .mark-cell label { display: block; font-size: 10px; font-weight: 600; color: var(--text-sec); margin-bottom: 4px; white-space: nowrap; }
    .mark-inp {
        width: 100%; padding: 10px 0; text-align: center; border: 1px solid var(--border); border-radius: 6px;
        font-size: 18px; font-weight: 700; background: var(--bg); color: var(--text);
    }
    .mark-inp:focus { border-color: var(--primary); background: var(--surface); }
    
    .btn-save { width: 100%; padding: 16px; background: var(--primary); color: var(--on-primary); border: none; font-size: 16px; font-weight: 600; border-radius: 12px; margin-top: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
    .btn-del { width: 100%; padding: 14px; background: var(--error-bg); color: var(--error); border: none; margin-top: 20px; border-radius: 8px; font-weight: 600; }

    /* TUTORIAL OVERLAY */
    .tut-overlay {
        display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.85); z-index: 2000;
        /* pointer-events: auto to block clicks to app */
    }
    .tut-spot {
        position: absolute; border-radius: 50%; box-shadow: 0 0 0 9999px rgba(0,0,0,0.85);
        border: 2px solid var(--primary); transition: all 0.5s ease; pointer-events: none;
    }
    .tut-msg {
        position: absolute; width: 85%; left: 50%; top: 50%; transform: translate(-50%, -50%);
        background: #fff; color: #000; padding: 25px 20px; border-radius: 16px; 
        text-align: center; animation: popUp 0.3s; pointer-events: auto;
    }
    .tut-btn { background: var(--primary); color: #fff; border: none; padding: 12px 24px; border-radius: 25px; font-weight: bold; font-size: 15px; }
    .tut-skip { background: none; border: none; color: #666; font-weight: 600; font-size: 14px; text-decoration: underline; padding: 10px; }
    .tut-close { position: absolute; top: 10px; right: 10px; background: none; border: none; font-size: 20px; color: #666; padding: 5px; }

    /* HELP & ABOUT */
    .help-item { padding: 15px 0; border-bottom: 1px solid var(--border); }
    .help-en { font-size: 14px; color: var(--text); margin-bottom: 6px; line-height: 1.4; }
    .help-od { font-size: 13px; color: var(--primary); background: rgba(11, 87, 208, 0.08); padding: 10px; border-radius: 8px; line-height: 1.5; }
    .legal-box { font-size: 12px; color: var(--text-sec); border: 1px solid var(--border); padding: 12px; border-radius: 8px; margin-top: 20px; text-align: left; }

    /* UTILS */
    .cfm-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1600; align-items: center; justify-content: center; backdrop-filter: blur(2px); }
    .cfm-box { background: var(--surface); padding: 25px; border-radius: 16px; width: 85%; max-width: 320px; text-align: center; }
    .toast { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%) translateY(50px); background: #323232; color: #fff; padding: 12px 24px; border-radius: 50px; font-size: 14px; opacity: 0; transition: 0.3s; pointer-events: none; z-index: 3000; white-space: nowrap; }
    .toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }

    /* ANIMATIONS */
    @keyframes fadeIn { from{opacity:0; transform:translateY(10px)} to{opacity:1; transform:translateY(0)} }
    @keyframes popUp { from{opacity:0; transform:scale(0.8)} to{opacity:1; transform:scale(1)} }

    /* PRINT STYLES (21 COLUMNS) */
    #print-wrap { display: none; }
    @media print {
        body * { visibility: hidden; }
        #print-wrap, #print-wrap * { visibility: visible; }
        #print-wrap { display: block; position: absolute; left: 0; top: 0; width: 100%; }
        @page { size: A4 landscape; margin: 5mm; }
        table { width: 100%; border-collapse: collapse; font-family: 'Times New Roman', serif; font-size: 8pt; color: black; }
        th, td { border: 0.5pt solid black; padding: 2px; text-align: center; vertical-align: middle; }
        thead th { background: #eee !important; font-weight: bold; -webkit-print-color-adjust: exact; }
        .v-th { height: 120px; vertical-align: bottom; }
        .v-txt { writing-mode: vertical-rl; transform: rotate(180deg); margin: 0 auto; white-space: nowrap; font-size: 6.5pt; line-height: 1.1; }
        .t-left { text-align: left; padding-left: 4px; }
        .p-head { text-align: center; border-bottom: 1px solid black; margin-bottom: 8px; padding-bottom: 5px; }
        .page-break { page-break-before: always; }
        .gt-cell { font-weight: bold; font-size: 10pt; background: #f5f5f5; }
    }
</style>
</head>
<body>


<header>
    <button class="menu-icon" id="menu-btn" onclick="toggleDrawer()">‚ò∞</button>
    <div class="header-titles">
        <h1 id="ui-school">My Govt School</h1>
        <p id="ui-class">Mark Register</p>
    </div>
    <button class="btn-pdf" id="hdr-pdf-btn" onclick="prepExport('single')">üìÑ PDF</button>
</header>
<div class="brand-strip">Developed by Sahil Kumar Rout</div>

<div class="container">
    <div id="list"></div>
</div>

<button class="fab" id="main-fab" onclick="editStudent(null)">+</button>

<div class="overlay" id="overlay" onclick="toggleDrawer()"></div>
<div class="drawer" id="drawer">
    <div class="drawer-head">
        <div>
            <div style="font-weight:700; font-size:16px;">Assess Offline</div>
            <div style="font-size:11px; opacity:0.7;">v2.6 (Gold)</div>
        </div>
        <button onclick="toggleDark()" style="background:none; border:none; font-size:22px;">üåó</button>
    </div>
    <div class="drawer-body">
        <div class="sec-title">School Profile</div>
        <div style="padding:0 16px;">
            <div class="inp-grp"><label>School Name</label><input type="text" id="menu-school" class="inp-txt" oninput="updCF('school', this.value)"></div>
            <div class="inp-grp"><label>UDISE</label><input type="text" id="menu-udise" class="inp-txt" oninput="updCF('udise', this.value)"></div>
            <div class="inp-grp"><label>Session</label><input type="text" id="menu-ses" class="inp-txt" oninput="updCF('session', this.value)"></div>
        </div>
        
        <div class="sec-title">Class Registers</div>
        <div id="menu-cls-list"></div>
        
        <div class="sec-title">Tools</div>
        <div onclick="prepExport('all')" class="menu-item">üñ®Ô∏è Print All Classes</div>
        <div onclick="genExcel()" class="menu-item">üìä Excel Export (.xls)</div>
        <div onclick="backupData()" class="menu-item">üíæ Backup Data</div>
        <div onclick="document.getElementById('file-res').click()" class="menu-item">üìÇ Restore Data</div>
        <input type="file" id="file-res" style="display:none" onchange="restoreData(this)" accept=".json">
        <div onclick="location.reload()" class="menu-item">üîÑ Reload App</div>

        <div class="sec-title">Help & Settings</div>
        <div onclick="startTutorial()" class="menu-item" style="color:var(--primary); font-weight:600">‚ú® Start Tutorial</div>
        <div onclick="openSettings()" class="menu-item">‚öôÔ∏è Settings</div>
        <div onclick="openHelp()" class="menu-item">‚ùì User Guide</div>
        <div onclick="openAbout()" class="menu-item">‚ÑπÔ∏è About</div>
        <div onclick="resetAll()" class="menu-item" style="color:var(--error); margin-top:20px;">‚ö†Ô∏è Factory Reset</div>
    </div>
</div>

<div class="modal" id="mod-edit">
    <div class="modal-head">
        <span id="edit-title" style="font-weight:700">Student</span>
        <button class="menu-icon" onclick="checkUnsaved()" style="margin:0">‚úï</button>
    </div>
    <div class="modal-body">
        <div class="inp-grp">
            <label>Student Name (Auto Capital)</label>
            <input type="text" id="inp-name" class="inp-txt" style="text-transform:uppercase" placeholder="ENTER NAME">
        </div>
        <div id="marks-area"></div>
        <button class="btn-save" onclick="preSaveCheck()">SAVE STUDENT</button>
        <button class="btn-del" id="btn-del" onclick="delStudent()" style="display:none">DELETE STUDENT</button>
    </div>
</div>

<div class="modal" id="mod-set">
    <div class="modal-head">
        <span style="font-weight:700">Settings</span>
        <button class="menu-icon" onclick="closeModal('mod-set')" style="margin:0">‚úï</button>
    </div>
    <div class="modal-body">
        <div class="inp-grp">
            <label>Report Language / ‡¨∞‡¨ø‡¨™‡≠ã‡¨∞‡≠ç‡¨ü ‡¨≠‡¨æ‡¨∑‡¨æ</label>
            <select id="cfg-lang" class="inp-txt">
                <option value="od">Odia (‡¨ì‡¨°‡¨º‡¨ø‡¨Ü) [Default]</option>
                <option value="en">English</option>
            </select>
        </div>
        
        <div class="set-box">
            <div class="set-title">Group A: Exam Limits (Max Marks)</div>
            <div style="display:flex; gap:10px;">
                <div class="inp-grp" style="flex:1"><label>FA Max</label><input type="number" id="lm-fa" class="inp-txt"></div>
                <div class="inp-grp" style="flex:1"><label>SA Max</label><input type="number" id="lm-sa" class="inp-txt"></div>
            </div>
            <div style="display:flex; gap:10px;">
                <div class="inp-grp" style="flex:1"><label>Written</label><input type="number" id="lm-wr" class="inp-txt"></div>
                <div class="inp-grp" style="flex:1"><label>Project</label><input type="number" id="lm-pr" class="inp-txt"></div>
            </div>
            <div style="font-size:11px; color:var(--text-sec)">Set Max Marks to <b>0</b> to disable an exam.</div>
        </div>

        <div class="set-box">
            <div class="set-title">Group B: Primary (1-5) Weight %</div>
            <div style="display:flex; gap:10px;">
                <div class="inp-grp" style="flex:1"><label>Written</label><input type="number" id="pr-wr" class="inp-txt"></div>
                <div class="inp-grp" style="flex:1"><label>Project</label><input type="number" id="pr-pr" class="inp-txt"></div>
            </div>
            <div class="inp-grp"><label>Annual Exam (SA2)</label><input type="number" id="pr-sa" class="inp-txt"></div>
        </div>

        <div class="set-box">
            <div class="set-title">Group C: Upper Pry (6-8) Weight %</div>
            <div style="display:flex; gap:10px;">
                <div class="inp-grp" style="flex:1"><label>Written</label><input type="number" id="up-wr" class="inp-txt"></div>
                <div class="inp-grp" style="flex:1"><label>Project</label><input type="number" id="up-pr" class="inp-txt"></div>
            </div>
            <div class="inp-grp"><label>Annual Exam (SA2)</label><input type="number" id="up-sa" class="inp-txt"></div>
        </div>
        
        <button class="btn-save" onclick="saveSettings()">SAVE SETTINGS</button>
    </div>
</div>

<div class="modal" id="mod-help">
    <div class="modal-head">
        <span style="font-weight:700">User Guide / ‡¨®‡¨ø‡¨∞‡≠ç‡¨¶‡≠ç‡¨¶‡≠á‡¨∂‡¨æ‡¨¨‡¨≥‡≠Ä</span>
        <button class="menu-icon" onclick="closeModal('mod-help')" style="margin:0">‚úï</button>
    </div>
    <div class="modal-body">
        <div class="help-item">
            <div class="help-en"><b>1. School Setup:</b> Tap Menu (‚ò∞). Enter School Name, UDISE, and Session.</div>
            <div class="help-od"><b>‡≠ß. ‡¨∏‡≠ç‡¨ï‡≠Å‡¨≤ ‡¨∏‡≠á‡¨ü‡¨ø‡¨Ç:</b> ‡¨Æ‡≠á‡¨®‡≠Å (‚ò∞) ‡¨ï‡≠Å ‡¨Ø‡¨æ‡¨á ‡¨∏‡≠ç‡¨ï‡≠Å‡¨≤‡¨∞ ‡¨®‡¨æ‡¨Æ, UDISE ‡¨ï‡≠ã‡¨°‡≠ç ‡¨è‡¨¨‡¨Ç ‡¨∂‡¨ø‡¨ï‡≠ç‡¨∑‡¨æ‡¨¨‡¨∞‡≠ç‡¨∑ ‡¨≤‡≠á‡¨ñ‡¨®‡≠ç‡¨§‡≠Å‡•§</div>
        </div>
        <div class="help-item">
            <div class="help-en"><b>2. Class Selection:</b> Open Menu. Tap on a Class Name (e.g., Class 1).<br><b>Status (5/12):</b> 5 students completed out of 12.<br><b style="color:var(--success)">Green:</b> Class is 100% Finished.</div>
            <div class="help-od"><b>‡≠®. ‡¨ï‡≠ç‡¨≤‡¨æ‡¨∏‡≠ç ‡¨¨‡¨æ‡¨õ‡¨ø‡¨¨‡¨æ:</b> ‡¨Æ‡≠á‡¨®‡≠Å ‡¨ñ‡≠ã‡¨≤‡¨ø ‡¨∂‡≠ç‡¨∞‡≠á‡¨£‡≠Ä ‡¨®‡¨æ‡¨Æ ‡¨â‡¨™‡¨∞‡≠á ‡¨ï‡≠ç‡¨≤‡¨ø‡¨ï‡≠ç ‡¨ï‡¨∞‡¨®‡≠ç‡¨§‡≠Å‡•§<br><b>‡¨∏‡≠ç‡¨•‡¨ø‡¨§‡¨ø (5/12):</b> 12 ‡¨ú‡¨£‡¨ô‡≠ç‡¨ï ‡¨Æ‡¨ß‡≠ç‡≠ü‡¨∞‡≠Å 5 ‡¨ú‡¨£‡¨ô‡≠ç‡¨ï‡¨∞ ‡¨ï‡¨æ‡¨Æ ‡¨∏‡¨∞‡¨ø‡¨õ‡¨ø‡•§<br><b style="color:var(--success)">‡¨∏‡¨¨‡≠Å‡¨ú (Green):</b> ‡¨ï‡≠ç‡¨≤‡¨æ‡¨∏‡≠ç ‡¨ï‡¨æ‡¨Æ ‡¨∏‡¨Æ‡≠ç‡¨™‡≠Ç‡¨∞‡≠ç‡¨£‡≠ç‡¨£ ‡¨∏‡¨∞‡¨ø‡¨Ø‡¨æ‡¨á‡¨õ‡¨ø‡•§</div>
        </div>
        <div class="help-item">
            <div class="help-en"><b>3. Add/Edit:</b> Tap <b>(+)</b>. If absent, type <b>'0'</b>. Never leave empty.</div>
            <div class="help-od"><b>‡≠©. ‡¨Æ‡¨æ‡¨∞‡≠ç‡¨ï ‡¨è‡¨£‡≠ç‡¨ü‡≠ç‡¨∞‡¨ø:</b> <b>(+)</b> ‡¨¶‡¨¨‡¨æ‡¨®‡≠ç‡¨§‡≠Å‡•§ ‡¨Ö‡¨®‡≠Å‡¨™‡¨∏‡≠ç‡¨•‡¨ø‡¨§ ‡¨•‡¨ø‡¨≤‡≠á <b>'0'</b> ‡¨≤‡≠á‡¨ñ‡¨®‡≠ç‡¨§‡≠Å‡•§ ‡¨ñ‡¨æ‡¨≤‡¨ø ‡¨õ‡¨æ‡¨°‡¨®‡≠ç‡¨§‡≠Å ‡¨®‡¨æ‡¨π‡¨ø‡¨Å‡•§</div>
        </div>
        <div class="help-item">
            <div class="help-en"><b>4. Reports:</b> Tap <b>[ üìÑ PDF ]</b> button in header. Use <b>Menu > Print All</b> for whole school. Language is Odia by default.</div>
            <div class="help-od"><b>‡≠™. ‡¨∞‡¨ø‡¨™‡≠ã‡¨∞‡≠ç‡¨ü:</b> ‡¨â‡¨™‡¨∞‡≠á ‡¨•‡¨ø‡¨¨‡¨æ <b>[ üìÑ PDF ]</b> ‡¨¨‡¨ü‡¨®‡≠ç ‡¨¶‡¨¨‡¨æ‡¨®‡≠ç‡¨§‡≠Å‡•§ ‡¨≠‡¨æ‡¨∑‡¨æ ‡¨ì‡¨°‡¨º‡¨ø‡¨Ü‡¨∞‡≠á ‡¨Ü‡¨∏‡¨ø‡¨¨‡•§</div>
        </div>
        <div class="help-item">
            <div class="help-en"><b>5. Settings:</b> Group B (Class 1-5). Group C (Class 6-8).</div>
            <div class="help-od"><b>‡≠´. ‡¨∏‡≠á‡¨ü‡¨ø‡¨Ç:</b> Group B (‡≠ß‡¨Æ-‡≠´‡¨Æ) ‡¨ì Group C (‡≠¨‡¨∑‡≠ç‡¨†-‡≠Æ‡¨Æ) ‡¨™‡¨æ‡¨á‡¨Å ‡¨ó‡≠Å‡¨∞‡≠Å‡¨§‡≠ç‡¨µ ‡¨®‡¨ø‡≠ü‡¨Æ‡•§</div>
        </div>
    </div>
</div>

<div class="modal" id="mod-abt">
    <div class="modal-head"><span style="font-weight:700">About</span><button class="menu-icon" onclick="closeModal('mod-abt')" style="margin:0">‚úï</button></div>
    <div class="modal-body" style="text-align:center">
        <h2 style="color:var(--primary); margin:10px 0;">Assess Offline</h2>
        <p style="opacity:0.7">v2.6 (Gold Edition)</p>
        <p style="font-weight:600">Developed by Sahil Kumar Rout</p>
        
        <div class="legal-box">
            <strong>PRIVACY POLICY & TERMS</strong><br><br>
            1. <strong>Data Ownership:</strong> This is a client-side app. We do not have a server. All data is stored locally on your device. You are the sole owner.<br><br>
            2. <strong>No Collection:</strong> The developer collects ZERO personal information. No tracking, no internet required.<br><br>
            3. <strong>Safety:</strong> Clearing browser history deletes data. Use "Backup Data" weekly to save a file to your Google Drive.<br><br>
            4. <strong>Disclaimer:</strong> Provided "as is" under MIT License. Developer is not liable for data loss.
        </div>
    </div>
</div>

<div class="tut-overlay" id="tut-over">
    <div class="tut-spot" id="tut-spot"></div>
    <div class="tut-msg" id="tut-msg">
        <button class="tut-close" onclick="endTut()">‚úï</button>
        <h3 id="tut-head" style="margin-top:0">Welcome!</h3>
        <p id="tut-txt" style="line-height:1.5">Let's take a quick tour.</p>
        <div style="display:flex; justify-content:space-between; align-items:center; margin-top:20px;">
            <button class="tut-skip" onclick="endTut()">Skip</button>
            <button class="tut-btn" onclick="nextTut()">Next ></button>
        </div>
    </div>
</div>

<div class="cfm-overlay" id="cfm-save">
    <div class="cfm-box">
        <div style="font-size:32px; margin-bottom:10px;">‚ö†Ô∏è</div>
        <h3>Incomplete?</h3>
        <p style="color:var(--text-sec)">Empty boxes will cause "Incomplete" status. Did you mean '0'?</p>
        <div style="display:flex; gap:10px; margin-top:20px;">
            <button class="tut-btn" style="background:var(--bg); color:var(--text); flex:1" onclick="document.getElementById('cfm-save').style.display='none'">Back</button>
            <button class="tut-btn" style="flex:1" onclick="confirmSave()">Save Anyway</button>
        </div>
    </div>
</div>

<div id="toast-box"></div>
<div id="print-wrap"></div>
<script>
// --- CONFIGURATION ---
const CFG = {
    school: "", udise: "", session: "2025-26", lang: "od",
    lm: { fa:25, sa:50, wr:10, pr:10 },
    pr: { t1:30, wr:10, pr:20, sa:40 }, // Class 1-5 Weights
    up: { t1:30, wr:5, pr:15, sa:50 }   // Class 6-8 Weights
};
const SUB_LIST = {
    1: "Language (Odia), Mathematics, EVS, Drawing",
    3: "Language (Odia), Mathematics, English, EVS, Drawing",
    6: "Language (Odia), Mathematics, English, Science, History & Civics, Geography, Hindi, Sanskrit, Drawing"
};
const OD_MAP = {
    "Language (Odia)": "‡¨≠‡¨æ‡¨∑‡¨æ (‡¨ì‡¨°‡¨º‡¨ø‡¨Ü)", "Mathematics": "‡¨ó‡¨£‡¨ø‡¨§", "EVS": "‡¨™‡¨∞‡¨ø‡¨¨‡≠á‡¨∂ ‡¨¨‡¨ø‡¨ú‡≠ç‡¨û‡¨æ‡¨®",
    "Drawing": "‡¨ö‡¨ø‡¨§‡≠ç‡¨∞‡¨æ‡¨ô‡≠ç‡¨ï‡¨®", "English": "‡¨á‡¨Ç‡¨∞‡¨æ‡¨ú‡≠Ä", "Science": "‡¨¨‡¨ø‡¨ú‡≠ç‡¨û‡¨æ‡¨®",
    "History & Civics": "‡¨á‡¨§‡¨ø‡¨π‡¨æ‡¨∏ ‡¨ì ‡¨®‡¨æ‡¨ó‡¨∞‡≠Ä‡¨ï ‡¨®‡≠Ä‡¨§‡¨ø", "Geography": "‡¨≠‡≠Ç‡¨ó‡≠ã‡¨≥",
    "Hindi": "‡¨π‡¨ø‡¨®‡≠ç‡¨¶‡≠Ä", "Sanskrit": "‡¨∏‡¨Ç‡¨∏‡≠ç‡¨ï‡≠É‡¨§"
};
const TR = {
    en: { n:"Name Of The Student", s:"Subject", t1:"(FA-1 + FA-2 + SA-1)", wgt:"SCORE @ [x]% weightage", asn:"Assignment", prj:"Project", sa2:"SA-2 / Annual Exam", tot:"TOTAL SCORE (SUBJECT)", gt:"GRAND TOTAL SCORE", pct:"GT SCORE %", best:"Best" },
    od: { n:"‡¨∂‡¨ø‡¨ï‡≠ç‡¨∑‡¨æ‡¨∞‡≠ç‡¨•‡≠Ä‡¨∞ ‡¨®‡¨æ‡¨Æ", s:"‡¨¨‡¨ø‡¨∑‡≠ü", t1:"(FA-1 + FA-2 + SA-1)", wgt:"‡¨™‡≠ç‡¨∞‡¨æ‡¨™‡≠ç‡¨§‡¨æ‡¨ô‡≠ç‡¨ï @ [x]% ‡¨ó‡≠Å‡¨∞‡≠Å‡¨§‡≠ç‡¨µ", asn:"‡¨≤‡¨ø‡¨ñ‡¨ø‡¨§ ‡¨ï‡¨æ‡¨∞‡≠ç‡¨Ø‡≠ç‡≠ü", prj:"‡¨™‡≠ç‡¨∞‡¨ï‡¨≥‡≠ç‡¨™ ‡¨ï‡¨æ‡¨∞‡≠ç‡¨Ø‡≠ç‡≠ü", sa2:"SA-2 / ‡¨¨‡¨æ‡¨∞‡≠ç‡¨∑‡¨ø‡¨ï ‡¨™‡¨∞‡≠Ä‡¨ï‡≠ç‡¨∑‡¨æ", tot:"‡¨Æ‡≠ã‡¨ü ‡¨™‡≠ç‡¨∞‡¨æ‡¨™‡≠ç‡¨∞‡¨æ‡¨ô‡≠ç‡¨ï (‡¨¨‡¨ø‡¨∑‡≠ü)", gt:"‡¨∏‡¨∞‡≠ç‡¨¨‡¨Æ‡≠ã‡¨ü ‡¨™‡≠ç‡¨∞‡¨æ‡¨™‡≠ç‡¨§‡¨æ‡¨ô‡≠ç‡¨ï", pct:"% ‡¨∏‡¨∞‡≠ç‡¨¨‡¨Æ‡≠ã‡¨ü ‡¨™‡≠ç‡¨∞‡¨æ‡¨™‡≠ç‡¨§‡¨æ‡¨ô‡≠ç‡¨ï", best:"‡¨∂‡≠ç‡¨∞‡≠á‡¨∑‡≠ç‡¨†" }
};

let db = { cf: JSON.parse(JSON.stringify(CFG)), st: {} };
let cls = "1";
let eIdx = null;
let tutStep = 0;

// --- INIT ---
function init() {
    let th = localStorage.getItem("theme");
    if(th === "dark") document.body.classList.add("dark");
    
    let s = localStorage.getItem("assess_v2_gold");
    if(s) {
        let ld = JSON.parse(s);
        db.cf = {...CFG, ...ld.cf}; 
        db.st = ld.st || {};
        if(!db.cf.lm) db.cf.lm={...CFG.lm};
        if(!db.cf.pr) db.cf.pr={...CFG.pr};
        if(!db.cf.up) db.cf.up={...CFG.up};
    } else {
        for(let i=1; i<=8; i++) db.st[i] = [];
        setTimeout(startTutorial, 1500); 
    }

    document.getElementById('menu-school').value = db.cf.school;
    document.getElementById('menu-udise').value = db.cf.udise;
    document.getElementById('menu-ses').value = db.cf.session;
    
    renderMenu();
    renderList();
    updUI();
}
function save() { localStorage.setItem("assess_v2_gold", JSON.stringify(db)); renderMenu(); renderList(); }
function toast(m) { let b=document.getElementById('toast-box'), t=document.createElement('div'); t.className='toast'; t.innerText=m; b.appendChild(t); setTimeout(()=>t.classList.add('show'),10); setTimeout(()=>{t.classList.remove('show');setTimeout(()=>t.remove(),300)},2500); }
function toggleDrawer() { 
    let d=document.getElementById('drawer'),o=document.getElementById('overlay'); 
    if(d.classList.contains('open')){d.classList.remove('open');o.classList.remove('show');setTimeout(()=>o.style.display='none',300)}
    else{o.style.display='block';setTimeout(()=>o.classList.add('show'),10);d.classList.add('open')} 
}
function toggleDark() { 
    document.body.classList.toggle('dark'); 
    localStorage.setItem("theme", document.body.classList.contains('dark') ? "dark" : "light");
}
function updCF(k,v) { db.cf[k]=v; save(); updUI(); }
function updUI() { document.getElementById('ui-school').innerText=db.cf.school||"My Govt School"; document.getElementById('ui-class').innerText=`Class ${cls} Register`; }

// --- MENU & LIST ---
function renderMenu() {
    let m = document.getElementById('menu-cls-list');
    m.innerHTML = "";
    for(let i=1; i<=8; i++) {
        let d = db.st[i]||[];
        let total = d.length;
        let comp = d.filter(s => checkComp(s, i)).length;
        let div = document.createElement('div');
        div.className = "menu-item" + (i.toString()===cls ? " active-cls" : "");
        div.innerHTML = `<span>Class ${i}</span><span class="count-badge ${comp===total && total>0 ? 'done':''}">${comp}/${total}</span>`;
        div.onclick = () => { cls=i.toString(); closeModal('mod-edit'); toggleDrawer(); renderMenu(); renderList(); updUI(); };
        m.appendChild(div);
    }
}
function checkComp(s, c) {
    if(!s.m) return false;
    let subs = getSubs(c), L = db.cf.lm;
    for(let sb of subs) {
        let mk = s.m[sb]||{};
        let keys = ['f1','f2','s1','s2'];
        if(L.wr > 0) keys.push('a1','a2');
        if(L.pr > 0) keys.push('p1','p2');
        for(let k of keys) if(mk[k]==="" || mk[k]===undefined) return false;
    }
    return true;
}
function renderList() {
    let l = document.getElementById('list');
    l.innerHTML = "";
    let data = db.st[cls]||[];
    if(data.length===0) { 
        l.innerHTML=`<div class="empty-state"><div class="empty-icon">üìÇ</div><div>No students in Class ${cls}.<br>Tap <b>+</b> to add.</div></div>`; 
        return; 
    }
    data.forEach((s, i) => {
        let res = calcStudent(s, cls);
        let tag = res.complete ? `<span class="tag com">‚úÖ Completed</span>` : `<span class="tag inc">‚ö†Ô∏è Incomplete</span>`;
        let d = document.createElement('div');
        d.className = "card" + (res.complete ? " pass" : "");
        d.innerHTML = `<div class="row-top"><div class="st-name">${i+1}. ${s.name}</div><div class="st-score-box"><div class="st-score">${res.gt}</div><div class="st-percent">${res.pct}%</div></div></div><div class="tags">${tag}</div>`;
        d.onclick = () => editStudent(i);
        l.appendChild(d);
    });
}

// --- CALCULATION ENGINE ---
function getSubs(c) {
    let n = parseInt(c);
    if(n>=6) return SUB_LIST[6].split(',').map(x=>x.trim());
    if(n>=3) return SUB_LIST[3].split(',').map(x=>x.trim());
    return SUB_LIST[1].split(',').map(x=>x.trim());
}
function getWeights(c) { return parseInt(c)<=5 ? db.cf.pr : db.cf.up; }

function calcStudent(s, c) {
    let subs = getSubs(c);
    let W = getWeights(c);
    let L = db.cf.lm;
    let gt = 0, complete = true;
    subs.forEach(sb => {
        let m = (s.m && s.m[sb]) ? s.m[sb] : {};
        if(!checkComp(s,c)) complete=false;
        let n = v => parseFloat(v)||0;
        
        let maxT1 = (L.fa*2)+L.sa;
        let wT1 = maxT1>0 ? ((n(m.f1)+n(m.f2)+n(m.s1)) / maxT1) * W.t1 : 0;
        
        let wA = L.wr>0 ? (Math.max(n(m.a1), n(m.a2)) / L.wr) * W.wr : 0;
        let wP = L.pr>0 ? (Math.max(n(m.p1), n(m.p2)) / L.pr) * W.pr : 0;
        let wS2 = L.sa>0 ? (n(m.s2) / L.sa) * W.sa : 0;
        
        gt += Math.ceil(wT1 + wA + wP + wS2);
    });
    let pct = subs.length ? ((gt / (subs.length*100))*100).toFixed(1) : 0;
    return { gt, pct, complete };
}

// --- EDIT ---
function editStudent(idx) {
    eIdx = idx;
    let s = (idx===null) ? {name:"", m:{}} : db.st[cls][idx];
    document.getElementById('edit-title').innerText = idx===null ? "Add Student" : "Edit Student";
    document.getElementById('inp-name').value = s.name;
    document.getElementById('mod-edit').style.display = 'block';
    document.getElementById('btn-del').style.display = idx===null ? 'none' : 'block';
    let box = document.getElementById('marks-area');
    box.innerHTML = "";
    let subs = getSubs(cls);
    let L = db.cf.lm;
    subs.forEach(sb => {
        let m = (s.m && s.m[sb]) ? s.m[sb] : {};
        let h = `<div class="sub-card"><div class="sub-head">${sb}</div>
        <div class="mark-grid">
            <div class="mark-cell"><label>FA1 /${L.fa}</label><input type="number" class="mark-inp" value="${m.f1||''}" data-s="${sb}" data-k="f1" data-mx="${L.fa}" oninput="chk(this)"></div>
            <div class="mark-cell"><label>FA2 /${L.fa}</label><input type="number" class="mark-inp" value="${m.f2||''}" data-s="${sb}" data-k="f2" data-mx="${L.fa}" oninput="chk(this)"></div>
            <div class="mark-cell"><label>SA1 /${L.sa}</label><input type="number" class="mark-inp" value="${m.s1||''}" data-s="${sb}" data-k="s1" data-mx="${L.sa}" oninput="chk(this)"></div>
        </div>`;
        if(L.wr > 0) {
            h += `<div class="mark-grid">
            <div class="mark-cell"><label>Assign 1 /${L.wr}</label><input type="number" class="mark-inp" value="${m.a1||''}" data-s="${sb}" data-k="a1" data-mx="${L.wr}" oninput="chk(this)"></div>
            <div class="mark-cell"><label>Assign 2 /${L.wr}</label><input type="number" class="mark-inp" value="${m.a2||''}" data-s="${sb}" data-k="a2" data-mx="${L.wr}" oninput="chk(this)"></div>`;
        }
        if(L.pr > 0) {
            if(L.wr === 0) h += `<div class="mark-grid">`; 
            h += `<div class="mark-cell"><label>Project 1 /${L.pr}</label><input type="number" class="mark-inp" value="${m.p1||''}" data-s="${sb}" data-k="p1" data-mx="${L.pr}" oninput="chk(this)"></div>
            <div class="mark-cell"><label>Project 2 /${L.pr}</label><input type="number" class="mark-inp" value="${m.p2||''}" data-s="${sb}" data-k="p2" data-mx="${L.pr}" oninput="chk(this)"></div></div>`;
        } else { if(L.wr > 0) h += `</div>`; }
        
        h += `<div class="mark-grid"><div class="mark-cell"><label>Annual (SA2) /${L.sa}</label><input type="number" class="mark-inp" value="${m.s2||''}" data-s="${sb}" data-k="s2" data-mx="${L.sa}" oninput="chk(this)"></div></div></div>`;
        box.innerHTML += h;
    });
}
function chk(el) {
    let mx = parseFloat(el.dataset.mx);
    if(parseFloat(el.value)>mx) { toast(`Max is ${mx}`); el.value=""; el.style.borderColor="var(--error)"; }
    else el.style.borderColor="var(--border)";
}
function preSaveCheck() {
    let empty = false;
    document.querySelectorAll('.mark-inp').forEach(i => { if(i.value==="") empty=true; });
    if(empty) document.getElementById('cfm-save').style.display = 'flex'; else confirmSave();
}
function confirmSave() {
    let n = document.getElementById('inp-name').value.toUpperCase().trim();
    if(!n) return toast("Name required");
    let marks = {};
    document.querySelectorAll('.mark-inp').forEach(i => {
        let s = i.dataset.s, k = i.dataset.k;
        if(!marks[s]) marks[s] = {};
        marks[s][k] = i.value;
    });
    let obj = { name:n, m:marks };
    if(eIdx===null) db.st[cls].push(obj); else db.st[cls][eIdx] = obj;
    document.getElementById('cfm-save').style.display='none';
    closeModal('mod-edit'); save(); toast("Saved");
}
function delStudent() { if(confirm("Delete Student?")) { db.st[cls].splice(eIdx,1); save(); closeModal('mod-edit'); toast("Deleted"); } }
function checkUnsaved() { if(confirm("Discard changes?")) closeModal('mod-edit'); }

// --- SETTINGS ---
function openSettings() {
    document.getElementById('cfg-lang').value = db.cf.lang;
    let L=db.cf.lm, P=db.cf.pr, U=db.cf.up;
    document.getElementById('lm-fa').value=L.fa; document.getElementById('lm-sa').value=L.sa;
    document.getElementById('lm-wr').value=L.wr; document.getElementById('lm-pr').value=L.pr;
    document.getElementById('pr-wr').value=P.wr; document.getElementById('pr-pr').value=P.pr; document.getElementById('pr-sa').value=P.sa;
    document.getElementById('up-wr').value=U.wr; document.getElementById('up-pr').value=U.pr; document.getElementById('up-sa').value=U.sa;
    if(document.getElementById('drawer').classList.contains('open')) toggleDrawer();
    document.getElementById('mod-set').style.display='block';
}
function saveSettings() {
    db.cf.lang = document.getElementById('cfg-lang').value;
    let L=db.cf.lm, P=db.cf.pr, U=db.cf.up;
    L.fa=p(document.getElementById('lm-fa')); L.sa=p(document.getElementById('lm-sa'));
    L.wr=p(document.getElementById('lm-wr')); L.pr=p(document.getElementById('lm-pr'));
    P.wr=p(document.getElementById('pr-wr')); P.pr=p(document.getElementById('pr-pr')); P.sa=p(document.getElementById('pr-sa'));
    U.wr=p(document.getElementById('up-wr')); U.pr=p(document.getElementById('up-pr')); U.sa=p(document.getElementById('up-sa'));
    save(); closeModal('mod-set'); toast("Updated");
}
function p(el) { return parseInt(el.value)||0; }

// --- TUTORIAL ---
function startTutorial() {
    if(document.getElementById('drawer').classList.contains('open')) toggleDrawer();
    closeModal('mod-edit');
    closeModal('mod-set');
    closeModal('mod-help');
    closeModal('mod-abt');
    tutStep = 1;
    setTimeout(() => {
        document.getElementById('tut-over').style.display = 'block';
        nextTut();
    }, 400);
}
function nextTut() {
    let h = document.getElementById('tut-head'), t = document.getElementById('tut-txt');
    if(tutStep === 1) {
        h.innerText = "Step 1: The Menu";
        t.innerText = "This is the Menu button. Tap it to Setup School and Select Class.";
        moveSpot(10, 10);
    } else if(tutStep === 2) {
        h.innerText = "Step 2: Add Student";
        t.innerText = "This is the Add button. Use it to add students and marks.";
        let r = document.getElementById('main-fab').getBoundingClientRect();
        moveSpot(r.left, r.top);
    } else if(tutStep === 3) {
        h.innerText = "Step 3: PDF Report";
        t.innerText = "Use this button to generate the Class Register PDF.";
        let r = document.getElementById('hdr-pdf-btn').getBoundingClientRect();
        moveSpot(r.left, r.top);
        document.querySelector('.tut-btn').innerText = "Finish";
    } else {
        endTut();
        toast("You are ready!");
    }
    tutStep++;
}
function moveSpot(x, y) {
    let s = document.getElementById('tut-spot');
    s.style.left = (x-10)+'px'; s.style.top = (y-10)+'px';
    s.style.width = '70px'; s.style.height = '70px';
}
function endTut() {
    document.getElementById('tut-over').style.display = 'none';
}

// --- EXPORT (FIXED) ---
function prepExport(mode) {
    try {
        let T = TR[db.cf.lang];
        let h = "";
        if(mode==='single') h = getHTML(cls, true, T);
        else for(let i=1;i<=8;i++) { 
            let t=getHTML(i.toString(), true, T); 
            if(t) h+=`<div class="page-break"></div>`+t; 
        }
        
        if(!h) return toast("No Data Found");
        
        let pWrap = document.getElementById('print-wrap');
        pWrap.innerHTML = h;
        // Delay to allow DOM to render before printing (Critical for Mobile)
        setTimeout(() => window.print(), 200);
    } catch(e) {
        alert("PDF Error: " + e.message);
    }
}

function getHTML(c, header, T) {
    let d = db.st[c]||[]; if(d.length===0) return "";
    let sbs = getSubs(c), W = getWeights(c), L = db.cf.lm;
    let isOd = db.cf.lang==='od';
    
    let hT1=T.wgt.replace('[x]',W.t1), hWr=T.wgt.replace('[x]',W.wr);
    let hPr=T.wgt.replace('[x]',W.pr), hSa=T.wgt.replace('[x]',W.sa);
    
    let h = header ? `<div class="p-head"><div class="p-school">${db.cf.school}</div><div style="font-size:12pt; font-weight:bold">MARK REGISTER ${db.cf.session} | CLASS: ${c} | UDISE: ${db.cf.udise}</div></div>` : "";
    
    h += `<table><thead><tr>
    <th rowspan="2" style="width:30px">Sl.</th><th rowspan="2" class="t-left" style="width:120px">${T.n}</th><th rowspan="2" class="t-left" style="width:80px">${T.s}</th>
    <th class="v-th"><div class="v-txt">FA-1</div></th><th class="v-th"><div class="v-txt">FA-2</div></th><th class="v-th"><div class="v-txt">SA-1</div></th>
    <th class="v-th"><div class="v-txt">${T.t1}</div></th><th class="v-th"><div class="v-txt">${hT1}</div></th>
    <th class="v-th"><div class="v-txt">${T.asn} 1</div></th><th class="v-th"><div class="v-txt">${T.asn} 2</div></th><th class="v-th"><div class="v-txt">${T.best}</div></th><th class="v-th"><div class="v-txt">${hWr}</div></th>
    <th class="v-th"><div class="v-txt">${T.prj} 1</div></th><th class="v-th"><div class="v-txt">${T.prj} 2</div></th><th class="v-th"><div class="v-txt">${T.best}</div></th><th class="v-th"><div class="v-txt">${hPr}</div></th>
    <th class="v-th"><div class="v-txt">${T.sa2}</div></th><th class="v-th"><div class="v-txt">${hSa}</div></th>
    <th class="v-th"><div class="v-txt">${T.tot}</div></th>
    <th rowspan="2"><div class="v-txt" style="font-size:10pt; font-weight:bold">${T.gt}</div></th><th rowspan="2"><div class="v-txt" style="font-size:10pt; font-weight:bold">${T.pct}</div></th>
    </tr><tr>
    <th>${L.fa}</th><th>${L.fa}</th><th>${L.sa}</th><th>100</th><th>${W.t1}%</th>
    <th>${L.wr}</th><th>${L.wr}</th><th>${L.wr}</th><th>${W.wr}%</th>
    <th>${L.pr}</th><th>${L.pr}</th><th>${L.pr}</th><th>${W.pr}%</th>
    <th>${L.sa}</th><th>${W.sa}%</th><th>100</th>
    </tr></thead><tbody>`;

    d.forEach((s, idx) => {
        let gt = 0, subRows = "", n = v => parseFloat(v)||0;
        sbs.forEach((sb) => {
            let m = (s.m && s.m[sb]) ? s.m[sb] : {};
            
            // Fix: sumT1 needs to be defined here
            let sumT1 = n(m.f1)+n(m.f2)+n(m.s1); 
            let maxT1 = (L.fa*2)+L.sa;
            let wT1 = maxT1>0 ? (sumT1/maxT1)*W.t1 : 0;
            
            let bA = L.wr>0 ? Math.max(n(m.a1),n(m.a2)) : 0;
            let wA = L.wr>0 ? (bA/L.wr)*W.wr : 0;
            
            let bP = L.pr>0 ? Math.max(n(m.p1),n(m.p2)) : 0;
            let wP = L.pr>0 ? (bP/L.pr)*W.pr : 0;
            
            let wS2 = L.sa>0 ? (n(m.s2)/L.sa)*W.sa : 0;
            
            let fin = Math.ceil(wT1+wA+wP+wS2);
            gt += fin;
            let dispSub = (isOd && OD_MAP[sb]) ? OD_MAP[sb] : sb;
            
            subRows += `<tr><td class="t-left">${dispSub}</td>
            <td>${m.f1||0}</td><td>${m.f2||0}</td><td>${m.s1||0}</td><td><b>${sumT1}</b></td><td>${wT1.toFixed(1)}</td>
            <td>${m.a1||0}</td><td>${m.a2||0}</td><td>${bA}</td><td>${wA.toFixed(1)}</td>
            <td>${m.p1||0}</td><td>${m.p2||0}</td><td>${bP}</td><td>${wP.toFixed(1)}</td>
            <td>${m.s2||0}</td><td>${wS2.toFixed(1)}</td><td style="font-weight:bold">${fin}</td></tr>`;
        });
        let rows = subRows.split('</tr>'); rows.pop();
        rows.forEach((r,ri) => {
            h += `<tr>`;
            if(ri===0) h += `<td rowspan="${sbs.length}">${idx+1}</td><td rowspan="${sbs.length}" class="t-left"><b>${s.name}</b></td>`;
            h += r.replace('<tr>','');
            if(ri===0) {
                let pct = sbs.length ? ((gt/(sbs.length*100))*100).toFixed(1) : 0;
                h += `<td rowspan="${sbs.length}" class="gt-cell">${gt}</td><td rowspan="${sbs.length}" class="gt-cell">${pct}%</td>`;
            }
            h += `</tr>`;
        });
    });
    return h + "</tbody></table>";
}

function genExcel() {
    let d = db.st[cls]||[];
    if(d.length===0) return toast("Empty Class");
    
    let t = getHTML(cls, false, TR[db.cf.lang]);
    let content = `
    <html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns="http://www.w3.org/TR/REC-html40">
    <head><meta charset="UTF-8"></head>
    <body>
    <h3>${db.cf.school} - Class ${cls}</h3>
    ${t}
    </body></html>`;

    // FIX: Using Blob + Append to Body ensures download works on Mobile
    let blob = new Blob([content], {type: 'application/vnd.ms-excel'});
    let url = URL.createObjectURL(blob);
    let a = document.createElement('a');
    a.href = url;
    a.download = `Register_${cls}.xls`;
    document.body.appendChild(a); // Critical step for mobile
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}

function closeModal(id) { document.getElementById(id).style.display='none'; }
function openHelp() { if(document.getElementById('drawer').classList.contains('open')) toggleDrawer(); document.getElementById('mod-help').style.display='block'; }
function openAbout() { if(document.getElementById('drawer').classList.contains('open')) toggleDrawer(); document.getElementById('mod-abt').style.display='block'; }
function backupData() { let a=document.createElement('a'); a.href="data:text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(db)); a.download="Assess_Backup.json"; a.click(); }
function restoreData(i) { let f=i.files[0]; if(!f)return; let r=new FileReader(); r.onload=(e)=>{try{db=JSON.parse(e.target.result);save();location.reload()}catch{toast("Error")}}; r.readAsText(f); }
function resetAll() { if(confirm("FACTORY RESET: All data will be lost. Confirm?")) { localStorage.removeItem("assess_v2_gold"); location.reload(); } }

init();
</script>
</body>
</html>